<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solo Leveling: The Board Game</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <audio id="bgm" loop></audio>

    <div id="app">
        <div id="screen-auth" class="screen active">
            <div class="auth-container">
                <h1 class="glitch">SYSTEM LOGIN</h1>
                <input type="text" id="auth-u" placeholder="HUNTER ID">
                <input type="password" id="auth-p" placeholder="ACCESS CODE">
                <div class="auth-buttons">
                    <button onclick="handleAuth('login')">LOGIN</button>
                    <button onclick="handleAuth('signup')">REGISTER</button>
                </div>
            </div>
        </div>

        <div id="screen-profile" class="screen">
            <div class="profile-header">
                <div class="rank-badge" id="prof-rank-box">
                    <span id="prof-rank-text">E-RANK</span>
                </div>
                <div class="hunter-info">
                    <h2 id="prof-name">HUNTER NAME</h2>
                    <p>MANA POINTS: <span id="prof-mana">0</span></p>
                    <p>W/L: <span id="prof-stats">0/0</span></p>
                </div>
            </div>
            <div class="menu-grid">
                <button onclick="showSoloOptions()">SOLO QUEST</button>
                <button onclick="showMultiplayer()">MULTI-GATE</button>
                <button onclick="requestRankings()">WORLD RANK</button>
            </div>
        </div>

        <div id="screen-multi" class="screen">
            <button class="back-btn" onclick="showScreen('screen-profile')">BACK</button>
            <h2>ACTIVE GATES</h2>
            <div id="gate-list"></div>
            <button class="create-btn" onclick="createGate()">CREATE NEW GATE</button>
        </div>

        <div id="screen-waiting" class="screen">
            <h2 id="wait-gate-name">GATE LOBBY</h2>
            <div id="wait-player-list"></div>
            <button id="confirm-btn" onclick="confirmReady()">READY TO ENTER</button>
        </div>

        <div id="screen-game" class="screen">
            <div id="game-container">
                <div id="board"></div>
                <div id="side-panel">
                    <div id="turn-indicator">SYSTEM MONITORING...</div>
                    <div id="player-ranks"></div> <div id="announcements"></div>
                    <button id="skill-btn" style="display:none;" onclick="useSkill()">ACTIVATE SKILL</button>
                    <button class="quit-btn" onclick="quitGame()">ABANDON QUEST</button>
                </div>
            </div>
        </div>

        <div id="chat-container" style="display:none;">
            <div id="chat-messages"></div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="Type message...">
                <button onclick="sendChatMessage()">SEND</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentUser = null;
        let currentRoomId = null;
        let currentBGM = "";

        // --- MUSIC STATE MACHINE ---
        function playMusic(track) {
            const audio = document.getElementById('bgm');
            if (currentBGM === track) return;
            currentBGM = track;
            audio.src = `/music/${track}`;
            audio.play().catch(e => console.log("Music wait for user interaction"));
        }

        // --- AUTH & NAVIGATION ---
        function handleAuth(type) {
            const u = document.getElementById('auth-u').value;
            const p = document.getElementById('auth-p').value;
            socket.emit('authRequest', { type, u, p });
        }

        socket.on('authSuccess', (data) => {
            currentUser = data;
            document.getElementById('prof-name').innerText = data.username;
            document.getElementById('prof-mana').innerText = data.mana;
            document.getElementById('prof-rank-text').innerText = data.rank;
            document.getElementById('prof-rank-box').style.borderColor = data.color;
            document.getElementById('prof-stats').innerText = `${data.wins}/${data.losses}`;
            
            showScreen('screen-profile');
            document.getElementById('chat-container').style.display = 'flex';
            playMusic('menu.mp3');
        });

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            // Logic to revert music if going back to profile
            if (id === 'screen-profile') {
                currentRoomId = null;
                playMusic('menu.mp3');
            }
        }

        // --- MULTIPLAYER LOGIC ---
        function showMultiplayer() {
            showScreen('screen-multi');
            socket.emit('requestGateList');
        }

        function createGate() {
            const name = prompt("Enter Gate Name:");
            if (name) socket.emit('createGate', { name, host: currentUser.username });
        }

        socket.on('updateGateList', (list) => {
            const container = document.getElementById('gate-list');
            container.innerHTML = '';
            list.forEach(gate => {
                const btn = document.createElement('button');
                btn.innerText = `${gate.name} (${gate.count}/4)`;
                btn.onclick = () => socket.emit('joinGate', { gateID: gate.id, user: currentUser.username });
                container.appendChild(btn);
            });
        });

        socket.on('waitingRoomUpdate', (room) => {
            currentRoomId = room.id;
            showScreen('screen-waiting');
            playMusic('waiting.mp3');
            const list = document.getElementById('wait-player-list');
            list.innerHTML = room.players.map(p => `<div>${p.name} ${p.confirmed ? '[READY]' : '[PREPARING]'}</div>`).join('');
        });

        function confirmReady() {
            socket.emit('playerConfirm', { gateID: currentRoomId });
        }

        function showSoloOptions() {
            const diff = confirm("Challenge Monarch Mode? (Cancel for Normal)") ? 'Monarch' : 'Easy';
            socket.emit('startSoloAI', { user: currentUser.username, diff });
        }

        // --- CHAT LOGIC ---
        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            if (input.value.trim() !== "") {
                socket.emit('sendMessage', {
                    roomId: currentRoomId,
                    message: input.value,
                    senderName: currentUser.username
                });
                input.value = "";
            }
        }

        socket.on('receiveMessage', (data) => {
            const chatBox = document.getElementById('chat-messages');
            const msg = document.createElement('div');
            msg.innerHTML = `<b style="color:#00d2ff">[${data.rank}] ${data.sender}:</b> ${data.text}`;
            chatBox.appendChild(msg);
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        // --- GAME LOGIC ---
        socket.on('gameStart', () => {
            showScreen('screen-game');
            playMusic('gameplay.mp3');
        });

        socket.on('gameStateUpdate', (room) => {
            renderBoard(room);
            renderRankList(room.players);
            const turnP = room.players[room.turn];
            document.getElementById('turn-indicator').innerText = `CURRENT TURN: ${turnP.name}`;
            
            const me = room.players.find(p => p.id === socket.id);
            const skillBtn = document.getElementById('skill-btn');
            if (me && me.powerUp) {
                skillBtn.style.display = 'block';
                skillBtn.innerText = `USE ${me.powerUp}`;
            } else {
                skillBtn.style.display = 'none';
            }
        });

        // FIXED ENCIRCLED PART: Only shows D-Rank / E-Rank
        function renderRankList(players) {
            const container = document.getElementById('player-ranks');
            container.innerHTML = '<h3>HUNTER STATUS</h3>';
            players.forEach(p => {
                const pDiv = document.createElement('div');
                pDiv.className = p.alive ? 'status-alive' : 'status-dead';
                // Using rankLabel from server which has High/Low removed
                pDiv.innerHTML = `
                    <span style="color:${p.color}">${p.name}</span>: 
                    ${p.mana} MP (${p.rankLabel})
                `;
                container.appendChild(pDiv);
            });
        }

        function renderBoard(room) {
            const board = document.getElementById('board');
            board.innerHTML = '';
            for (let y = 0; y < 15; y++) {
                for (let x = 0; x < 15; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    const gate = room.world[`${x}-${y}`];
                    if (gate) {
                        cell.style.backgroundColor = gate.color;
                        cell.innerText = gate.rank;
                    }
                    room.players.forEach(p => {
                        if (p.alive && p.x === x && p.y === y) {
                            const pToken = document.createElement('div');
                            pToken.className = 'player-token';
                            pToken.style.backgroundColor = p.color;
                            if (p.id === socket.id) pToken.classList.add('me');
                            cell.appendChild(pToken);
                        }
                    });
                    cell.onclick = () => {
                        const me = room.players.find(p => p.id === socket.id);
                        if (me && room.players[room.turn].id === socket.id) {
                            if (Math.abs(me.x - x) <= 1 && Math.abs(me.y - y) <= 1) {
                                socket.emit('playerAction', { tx: x, ty: y });
                            }
                        }
                    };
                    board.appendChild(cell);
                }
            }
        }

        socket.on('announcement', (txt) => {
            const area = document.getElementById('announcements');
            const entry = document.createElement('div');
            entry.innerText = `> ${txt}`;
            area.prepend(entry);
        });

        socket.on('playMusic', (track) => playMusic(track));

        socket.on('returnToProfile', () => {
            showScreen('screen-profile');
            currentRoomId = null;
        });

        function quitGame() {
            if (confirm("ABANDON QUEST? (Loss and -20MP penalty)")) {
                socket.emit('quitGame');
            }
        }

        function useSkill() {
            const me = room.players.find(p => p.id === socket.id);
            if (me && me.powerUp) {
                socket.emit('activateSkill', { powerUp: me.powerUp });
            }
        }
    </script>
</body>
</html>

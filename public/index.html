<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SOLO LEVELING BOARD GAME</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@1,900&family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <style>
        :root { --sys-blue: #00d2ff; --sys-red: #ff003c; --sys-gold: #ffcc00; --sys-silver: #c0c0c0; }
        body { background: #000; color: white; font-family: 'Exo 2', sans-serif; margin: 0; overflow: hidden; }
        h1, h2, h3 { font-family: 'Orbitron'; font-style: italic; color: var(--sys-blue); text-shadow: 0 0 10px var(--sys-blue); }
        .screen { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100vh; width: 100vw; position: absolute; }
        .active { display: flex !important; }
        .sys-btn { background: #000; border: 2px solid var(--sys-blue); color: var(--sys-blue); padding: 10px 40px; font-family: 'Orbitron'; cursor: pointer; margin: 10px; font-weight: 900; clip-path: polygon(15% 0, 100% 0, 85% 100%, 0 100%); width: 250px; text-transform: uppercase; transition: 0.2s; }
        .sys-btn:hover { background: var(--sys-blue); color: #000; }
        .sys-input { padding: 15px; background: #000; border: 1px solid var(--sys-blue); color: #fff; width: 300px; margin: 10px; font-family: 'Orbitron'; outline: none; }
        
        /* Game Board */
        #game-board { display: grid; grid-template-columns: repeat(15, 42px); gap: 2px; background: #111; border: 4px solid var(--sys-blue); }
        .cell { width: 42px; height: 42px; background: #000; position: relative; border: 0.5px solid #1a1a1a; }
        .valid-move { box-shadow: inset 0 0 0 3px var(--sys-blue); cursor: pointer; z-index: 5; }
        
        /* Humanoid Render */
        .humanoid { position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); width: 24px; height: 30px; z-index: 10; pointer-events: none; }
        .h-head { width: 10px; height: 10px; border-radius: 50%; border: 1px solid white; margin: 0 auto; }
        .h-body { width: 20px; height: 15px; border: 1px solid white; border-radius: 4px 4px 0 0; }
        .name-tag { position: absolute; top: -22px; left: 50%; transform: translateX(-50%); font-size: 10px; white-space: nowrap; font-weight: 900; background: #000; border: 1px solid #444; padding: 1px 4px; display: flex; flex-direction: column; align-items: center; }
        
        /* UI Panels */
        .hud-left { width: 280px; background: rgba(0,0,0,0.9); border-right: 2px solid var(--sys-blue); padding: 15px; display: flex; flex-direction: column; height: 650px; overflow-y: auto; }
        .sidebar { width: 350px; border: 2px solid var(--sys-blue); background: #000; padding: 15px; height: 650px; display: flex; flex-direction: column; }
        .chat-container { flex-grow: 1; background: #050505; border: 1px solid #222; margin-top: 10px; display: flex; flex-direction: column; overflow: hidden; }
        .chat-msgs { flex-grow: 1; overflow-y: auto; padding: 10px; font-size: 12px; }
        .chat-input-area { display: flex; border-top: 1px solid #222; }
        .chat-input { background: #000; border: none; color: white; padding: 8px; flex-grow: 1; font-family: 'Exo 2'; }
        
        .chat-msg { margin-bottom: 4px; border-bottom: 1px solid #111; padding-bottom: 2px; }
        .chat-rank { color: var(--sys-blue); font-size: 10px; margin-right: 5px; }
        
        #vs-panel { display: none; background: rgba(20,0,0,0.95); border: 2px solid var(--sys-red); padding: 15px; margin-top: 10px; flex-direction: column; align-items: center; box-shadow: 0 0 20px var(--sys-red); z-index: 1000; }
        .v-fill { height: 6px; background: var(--sys-red); width: 0%; transition: 5s linear; margin-top: 10px; }
        #victory-screen { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <audio id="sys-bgm" loop>
        <source id="bgm-source" src="/music/menu.mp3" type="audio/mpeg">
    </audio>

    <div id="victory-screen">
        <h1 style="font-size: 5rem; color: var(--sys-gold);">QUEST COMPLETE</h1>
        <h2 id="winner-name" style="font-size: 3rem; color: #fff;">---</h2>
        <p>RECALCULATING WORLD RANKINGS...</p>
    </div>

    <div id="screen-auth" class="screen active">
        <h1 style="font-size: 4rem; letter-spacing: 15px;">SYSTEM</h1>
        <input type="text" id="u" class="sys-input" placeholder="HUNTER ID">
        <input type="password" id="p" class="sys-input" placeholder="ACCESS CODE">
        <button class="sys-btn" onclick="auth('login')">LOGIN</button>
        <button class="sys-btn" style="border-color:#444;" onclick="auth('signup')">CREATE RECORD</button>
    </div>

    <div id="screen-menu" class="screen">
        <div style="position:absolute; right:40px; top:20px; text-align:right;">
            <h1 id="st-name" style="font-size: 2.8rem; margin:0;">---</h1>
            <div id="st-world-rank" style="font-size: 1.2rem; font-weight: 900; margin: 5px 0;">WORLD RANK: ---</div>
            <div id="st-stats" style="font-size: 1rem; color: #aaa; margin-bottom: 5px;">WINS: 0 | LOSSES: 0</div>
            <div id="st-rank" style="font-size: 1.8rem; font-weight: 900; margin:0;">---</div>
            <div id="st-mp" style="font-size: 1.5rem; margin:0; color:white;">MP: ---</div>
        </div>
        
        <div style="display: flex; gap: 20px;">
            <div style="border:2px solid var(--sys-blue); width:400px; padding:20px; background:rgba(0,0,0,0.8);">
                <h3>WORLD RANKINGS</h3>
                <div id="world-rank-list" style="height: 300px; overflow-y: auto;"></div>
            </div>
            <div class="sidebar" style="height: 400px; width: 300px;">
                <h3>GLOBAL CHANNEL</h3>
                <div class="chat-container">
                    <div id="global-chat-msgs" class="chat-msgs"></div>
                    <div class="chat-input-area">
                        <input type="text" id="global-chat-input" class="chat-input" placeholder="Broadcast to all hunters...">
                        <button onclick="sendChat('global')" style="background:var(--sys-blue); border:none; padding:5px 10px;">SEND</button>
                    </div>
                </div>
            </div>
        </div>

        <div style="margin-top: 20px;">
            <button class="sys-btn" onclick="showScreen('screen-difficulty')">SINGLE PLAYER</button>
            <button class="sys-btn" onclick="openOnlineLobby()">MULTIPLAYER</button>
            <button class="sys-btn" style="border-color:#555;" onclick="location.reload()">LOGOUT</button>
        </div>
    </div>

    <div id="screen-game" class="screen" style="flex-direction: row; justify-content: center; align-items: center;">
        <div class="hud-left">
            <h3>HOW TO PLAY</h3>
            <div class="guide-box">
                <p style="color:var(--sys-gold); font-weight:900; margin:0 0 5px 0;">SYSTEM RULES:</p>
                <p style="margin:0; font-size:11px; line-height:1.4;">
                    1. Absorb <b style="color:#00ff00;">Mana Gates</b> to grow stronger.<br>
                    2. If last player, a <b style="color:var(--sys-silver);">SILVER GATE</b> spawns (500+ MP).<br>
                    3. If survivor loses to Silver Gate, <b style="color:cyan;">ALL HUNTERS REAWAKEN</b>.
                </p>
            </div>

            <h3>PARTY CHAT</h3>
            <div class="chat-container">
                <div id="game-chat-msgs" class="chat-msgs"></div>
                <div class="chat-input-area">
                    <input type="text" id="game-chat-input" class="chat-input" placeholder="Party message...">
                    <button onclick="sendChat('game')" style="background:var(--sys-blue); border:none;">SEND</button>
                </div>
            </div>
        </div>

        <div style="display:flex; gap:20px;">
            <div id="game-board"></div>
            <div class="sidebar">
                <h3 id="turn-txt" style="color:var(--sys-gold); font-size: 14px;">>> SYSTEM TURN</h3>
                <div id="party-list"></div>
                
                <div id="vs-panel">
                    <span id="vs-title" style="color:var(--sys-red); font-weight:900;">COMBAT INITIATED</span>
                    <div id="vs-data" style="font-size: 18px; text-align: center; margin: 10px 0;"></div>
                    <div id="skill-area"></div>
                    <div style="width:100%; height:4px; background:#111;"><div class="v-fill" id="vs-fill"></div></div>
                </div>

                <div id="turn-counter">
                    <div id="tc-spawn-text">RANDOM GATE: <span id="tc-spawn">3</span> ROUNDS</div>
                    <div id="tc-silver-container" style="display:none; color:var(--sys-silver); border: 2px solid var(--sys-silver); padding: 5px; margin-top: 5px;">
                        SILVER GATE DETECTED | POWER: <span id="silver-power">???</span>
                    </div>
                </div>
                <div id="announcement-board" style="flex-grow:1; background:#050505; font-size:11px; margin-top:10px; overflow-y:auto; padding:10px; border:1px solid #222;"></div>
                <button class="sys-btn" style="width:100%; height:45px; font-size:12px; margin-top:10px;" onclick="quitAction()">QUIT QUEST</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let myHunter = null, myRoomID = null;

        // --- AUDIO SYSTEM ---
        const bgm = document.getElementById('sys-bgm');
        const bgmSource = document.getElementById('bgm-source');
        const TRACKS = {
            'screen-auth': '/music/menu.mp3',
            'screen-menu': '/music/menu.mp3',
            'screen-online': '/music/menu.mp3',
            'screen-difficulty': '/music/menu.mp3',
            'screen-waiting': '/music/waiting.mp3',
            'screen-game': '/music/gameplay.mp3'
        };

        function playMusicForScreen(screenId) {
            const trackPath = TRACKS[screenId];
            if (trackPath && !bgmSource.src.includes(trackPath)) {
                bgmSource.src = trackPath;
                bgm.load();
                bgm.play().catch(() => {});
            }
        }

        // --- AUTH & NAVIGATION ---
        function showScreen(id) { 
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); 
            const target = document.getElementById(id);
            if(target) target.classList.add('active'); 
            playMusicForScreen(id);

            if(id === 'screen-menu' && myHunter) { 
                socket.emit('requestWorldRankings');
            }
        }
        
        function auth(type) { 
            const u = document.getElementById('u').value, p = document.getElementById('p').value;
            if(!u || !p) return alert("ENTER CREDENTIALS");
            bgm.play().catch(() => {}); 
            socket.emit('authRequest', { type, u, p }); 
        }

        socket.on('authSuccess', (d) => { 
            myHunter = d;
            // Update the UI with data from Supabase
            document.getElementById('st-name').innerText = d.username;
            document.getElementById('st-rank').innerText = d.rank; 
            document.getElementById('st-mp').innerText = `MP: ${d.mana}`;
            document.getElementById('st-stats').innerText = `WINS: ${d.wins || 0} | LOSSES: ${d.losses || 0}`;
            showScreen('screen-menu'); 
        });

        socket.on('authError', (msg) => alert(msg));

        socket.on('updateWorldRankings', (l) => {
            const list = document.getElementById('world-rank-list');
            list.innerHTML = l.map((h, i) => `
                <div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #222; font-weight:900;">
                    <span>#${i+1} ${h.username}</span> <span>${h.manapoints} MP</span>
                </div>`).join('');
            
            // Find our specific rank in the global list
            const myPos = l.findIndex(h => h.username === myHunter.username);
            if(myPos !== -1) document.getElementById('st-world-rank').innerText = `WORLD RANK: #${myPos + 1}`;
        });

        // --- CHAT LOGIC ---
        function sendChat(type) {
            const input = document.getElementById(`${type}-chat-input`);
            if(!input || !input.value.trim() || !myHunter) return;
            socket.emit('sendMessage', {
                roomId: (type === 'global') ? null : myRoomID,
                message: input.value,
                senderName: myHunter.username
            });
            input.value = "";
        }

        socket.on('receiveMessage', (d) => {
            const isWaiting = document.getElementById('screen-waiting').classList.contains('active');
            const container = document.getElementById(isWaiting ? 'room-chat-msgs' : 'game-chat-msgs');
            if(container) {
                container.innerHTML += `<div class="chat-msg"><span class="chat-rank">[${d.rank}]</span><b>${d.sender}:</b> ${d.text}</div>`;
                container.scrollTop = container.scrollHeight;
            }
        });

        socket.on('receiveGlobalMessage', (d) => {
            const container = document.getElementById('global-chat-msgs');
            if(container) {
                container.innerHTML += `<div class="chat-msg"><b>${d.sender}:</b> ${d.text}</div>`;
                container.scrollTop = container.scrollHeight;
            }
        });

        // ... GAMEPLAY LOGIC (joinGate, playerAction, etc.) ...
        // Ensure you have logic to set myRoomID when joining a gate
        socket.on('gameStart', () => {
            showScreen('screen-game');
        });

        function quitAction() { socket.emit('quitGame'); location.reload(); }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HUNTER SYSTEM - ORIGIN</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@1,900&family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --sys-blue: #00d2ff; --sys-gold: #ffcc00; --sys-silver: #ffffff; 
            --rank-s: #ff0000; --rank-a: #ff00ff; --rank-b: #ff9900; --rank-c: #ffff00; --rank-d: #99ff00; --rank-e: #00ff00; 
        }
        body { background: #000; color: white; font-family: 'Exo 2', sans-serif; margin: 0; overflow: hidden; user-select: none; }
        h1, h2, h3 { font-family: 'Orbitron'; font-style: italic; color: var(--sys-blue); text-shadow: 0 0 10px var(--sys-blue); margin: 5px 0; }
        .screen { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100vh; width: 100vw; position: absolute; inset: 0; background: #000; z-index: 10; }
        .active { display: flex !important; }
        .sys-btn { background: #000; border: 2px solid var(--sys-blue); color: var(--sys-blue); padding: 12px 30px; font-family: 'Orbitron'; cursor: pointer; margin: 8px; font-weight: 900; clip-path: polygon(10% 0, 100% 0, 90% 100%, 0 100%); width: 260px; text-transform: uppercase; transition: 0.2s; letter-spacing: 2px; }
        .sys-btn:hover { background: var(--sys-blue); color: #000; box-shadow: 0 0 15px var(--sys-blue); }
        .sys-btn.danger { border-color: var(--rank-s); color: var(--rank-s); }
        .sys-btn.gold { border-color: var(--sys-gold); color: var(--sys-gold); }
        .sys-input { padding: 15px; background: rgba(0,0,0,0.8); border: 1px solid var(--sys-blue); color: #fff; width: 300px; margin: 10px; font-family: 'Orbitron'; outline: none; text-align: center; font-size: 1.1rem; }
        #game-board { display: grid; grid-template-columns: repeat(15, 42px); gap: 2px; background: #111; border: 4px solid var(--sys-blue); }
        .cell { width: 42px; height: 42px; background: #050505; position: relative; border: 0.5px solid #1a1a1a; }
        .valid-move { box-shadow: inset 0 0 0 2px var(--sys-blue); cursor: pointer; background: rgba(0, 210, 255, 0.1); }
        .silver-monarch { box-shadow: 0 0 15px white, inset 0 0 10px white !important; animation: pulse-silver 1.5s infinite alternate; }
        .humanoid { position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); width: 24px; height: 30px; pointer-events: none; z-index: 10; }
        .name-tag { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 9px; white-space: nowrap; font-weight: 900; background: rgba(0,0,0,0.9); border: 1px solid #444; padding: 2px 4px; display: flex; flex-direction: column; align-items: center; }
        .chat-container { display: flex; flex-direction: column; background: rgba(0,0,0,0.6); border: 1px solid #333; flex-grow: 1; min-height: 0; }
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 10px; font-size: 0.8rem; }
        .chat-input-area { display: flex; border-top: 1px solid #333; }
        .chat-input-area input { flex-grow: 1; background: transparent; border: none; color: white; padding: 10px; outline: none; }
        .chat-input-area button { background: #222; color: var(--sys-blue); border: none; padding: 0 20px; cursor: pointer; }
        #vs-panel { display: none; background: rgba(10,0,0,0.95); border: 2px solid var(--rank-s); padding: 15px; margin-bottom: 10px; flex-direction: column; align-items: center; box-shadow: 0 0 20px var(--rank-s); }
        .v-fill { height: 8px; background: var(--rank-s); width: 0%; margin-top: 10px; }
        .rank-table { width: 100%; font-size: 0.75rem; border-collapse: collapse; color: #888; margin-top: auto; }
        #transition-overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; opacity: 0; transition: opacity 0.5s; }
        .loader-ring { width: 100px; height: 100px; border: 5px solid #111; border-top: 5px solid var(--sys-blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse-silver { 0% { box-shadow: 0 0 10px white; } 100% { box-shadow: 0 0 25px white; } }
        .hud-left, .hud-right { width: 300px; display: flex; flex-direction: column; height: 600px; padding: 0 20px; }
    </style>
</head>
<body>

    <audio id="bgm" loop></audio>

    <div id="transition-overlay">
        <div class="loader-ring"></div>
        <h2 style="letter-spacing: 5px;">GATE TRANSFER...</h2>
    </div>

    <div id="victory-screen" class="screen">
        <h1 style="font-size: 5rem; color: var(--sys-gold);">QUEST COMPLETE</h1>
        <h2 id="winner-name">---</h2>
        <div id="reward-info" style="font-size: 1.5rem; margin: 20px 0;"></div>
        <div>RETURNING IN 5 SECONDS...</div>
    </div>

    <div id="screen-auth" class="screen active">
        <h1>HUNTER SYSTEM</h1>
        <div id="auth-msg"></div>
        <input type="text" id="u" class="sys-input" placeholder="NAME">
        <input type="password" id="p" class="sys-input" placeholder="KEY">
        <div style="display:flex; gap:10px;">
            <button class="sys-btn" onclick="auth('login')">LOGIN</button>
            <button class="sys-btn" onclick="auth('signup')">REGISTER</button>
        </div>
    </div>

    <div id="screen-menu" class="screen">
        <div class="profile-container">
            <div class="menu-section" style="flex: 2;">
                <h3>WORLD RANKING</h3>
                <div id="world-rank-list" style="overflow-y: auto; flex-grow: 1;"></div>
                <div style="height: 250px; display: flex; flex-direction: column;">
                    <div style="background: var(--sys-blue); color:black; padding: 5px;">GLOBAL</div>
                    <div id="chat-global-anchor" style="flex-grow: 1; position: relative;"></div>
                </div>
            </div>
            <div class="menu-section" style="flex: 1; align-items: flex-end;">
                <h1 id="p-name">---</h1>
                <div id="p-wr" style="color: var(--sys-gold);">RANK #--</div>
                <div id="p-rank">---</div>
                <div id="p-stats">W: 0 | L: 0</div>
                <div id="p-mp">HuP: ---</div>
                <div style="margin-top: auto; display: flex; flex-direction: column; gap: 10px; width: 100%;">
                    <button class="sys-btn gold" onclick="startAI('Monarch')">MONARCH MODE (+5)</button>
                    <button class="sys-btn" style="border-color:var(--sys-blue); color:var(--sys-blue)" onclick="window.open('/guide.html', '_blank')">SYSTEM GUIDE</button>
                    <button class="sys-btn" onclick="openOnlineLobby()">MULTIPLAYER</button>
                    <button class="sys-btn danger" onclick="doLogout()">LOGOUT</button>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-lobby" class="screen">
        <div id="room-list" style="width: 80%; flex-grow: 1;"></div>
        <button class="sys-btn" onclick="showScreen('screen-menu')">BACK</button>
    </div>

    <div id="screen-waiting" class="screen">
        <h2 id="wr-title">---</h2>
        <div id="wr-players" style="width: 50%;"></div>
        <button id="btn-ready" class="sys-btn gold" onclick="playerConfirm()">READY</button>
        <button class="sys-btn danger" onclick="leaveWaitingRoom()">LEAVE</button>
    </div>

    <div id="screen-game" class="screen" style="flex-direction: row;">
        <div class="hud-left">
            <h3 id="turn-indicator">---</h3>
            <div id="ingame-party"></div>
            <div id="chat-game-anchor" style="flex-grow: 1; position: relative;"></div>
        </div>
        <div style="display: flex; flex-direction: column; align-items: center;">
            <div id="game-board"></div>
        </div>
        <div class="hud-right">
            <div id="vs-panel">
                <div style="color: var(--rank-s);">COMBAT</div>
                <div id="vs-content"></div>
                <button id="btn-powerup" class="sys-btn gold" style="display:none; width: 100%; margin: 5px 0;" onclick="usePowerUp()">ACTIVATE RUNE</button>
                <div style="width: 100%; background: #222; height: 8px;"><div class="v-fill" id="vs-bar"></div></div>
            </div>
            <div id="announcement-feed" style="height: 150px; overflow-y: auto;"></div>
            <table class="rank-table">
                <tr><td style="color:var(--rank-s)">Rank S</td><td>901+</td></tr>
                <tr><td style="color:var(--rank-a)">Rank A</td><td>701-900</td></tr>
                <tr><td style="color:var(--rank-b)">Rank B</td><td>501-700</td></tr>
                <tr><td style="color:var(--rank-c)">Rank C</td><td>301-500</td></tr>
                <tr><td style="color:var(--rank-d)">Rank D</td><td>101-300</td></tr>
                <tr><td style="color:var(--rank-e)">Rank E</td><td>0-100</td></tr>
            </table>
            <button class="sys-btn danger" onclick="quitAction()">QUIT</button>
        </div>
    </div>

    <div id="chat-template" style="display:none;">
        <div class="chat-container">
            <div class="chat-messages"></div>
            <div class="chat-input-area"><input type="text"><button>SEND</button></div>
        </div>
    </div>

    <script>
        const socket = io();
        let myHunter = null; let myRoomID = 'global'; let currentPass = ""; let currentGateID = null; let currentGameState = null; let currentHunterPowerUp = null;
        const POWER_ICONS = { 'DOUBLE DAMAGE': '‚öîÔ∏è', 'GHOST WALK': 'üë£', 'NETHER SWAP': 'üåÄ', 'RULERS AUTHORITY': 'üëë' };
        const BGM = document.getElementById('bgm');
        function playTrack(n) { if(n && BGM.src.indexOf(n) === -1) { BGM.src=`/music/${n}`; BGM.play().catch(()=>{}); } }

        window.onload = () => {
            const s = sessionStorage.getItem('hunter_creds');
            if(s) { const c=JSON.parse(s); auth('login', c.u, c.p); }
        };

        function auth(t, uIn, pIn) {
            const u = uIn || document.getElementById('u').value; const p = pIn || document.getElementById('p').value;
            if(!u || !p) return; currentPass = p; myHunter = { username: u }; socket.emit('authRequest', { type: t, u, p });
        }

        socket.on('authSuccess', (d) => {
            myHunter = d; sessionStorage.setItem('hunter_creds', JSON.stringify({u: d.username, p: currentPass}));
            document.getElementById('p-name').innerText = d.username;
            document.getElementById('p-rank').innerText = d.rank;
            document.getElementById('p-mp').innerText = `HuP: ${d.mana}`;
            showScreen('screen-menu');
            if(d.music) playTrack(d.music);
        });

        socket.on('authError', (m) => alert(m));

        let chatElement = null;
        function initChat() {
            const t = document.getElementById('chat-template'); chatElement = t.firstElementChild.cloneNode(true);
            const btn = chatElement.querySelector('button'); const inp = chatElement.querySelector('input');
            const send = () => { if(inp.value.trim()){ socket.emit('sendMessage', { message: inp.value, senderName: myHunter.username, roomId: myRoomID }); inp.value=''; } };
            btn.onclick = send; inp.onkeydown = (e) => { if(e.key==='Enter') send(); };
        }
        initChat();

        function moveChatTo(aId, rId) { myRoomID=rId; socket.emit('joinChatRoom', rId); document.getElementById(aId).appendChild(chatElement); }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'screen-menu') moveChatTo('chat-global-anchor', 'global');
            else if(id === 'screen-lobby') moveChatTo('chat-lobby-anchor', 'lobby_main');
            else if (id === 'screen-waiting') moveChatTo('chat-waiting-anchor', currentGateID);
            else if (id === 'screen-game') { playTrack('gameplay.mp3'); moveChatTo('chat-game-anchor', currentGateID); }
        }

        function transportAnimation(cb) {
            const o = document.getElementById('transition-overlay'); o.style.display='flex'; setTimeout(()=>o.style.opacity=1,10);
            setTimeout(() => { cb(); setTimeout(() => { o.style.opacity=0; setTimeout(()=>o.style.display='none',500); }, 1000); }, 1500);
        }

        function startAI(diff) { transportAnimation(() => socket.emit('startSoloAI', { user: myHunter.username, diff })); }
        function openOnlineLobby() { showScreen('screen-lobby'); socket.emit('requestGateList'); }
        socket.on('updateGateList', (l) => {
            document.getElementById('room-list').innerHTML = l.map(r => `<div class="room-item" onclick="socket.emit('joinGate', {gateID:'${r.id}', user:'${myHunter.username}'})"><span>${r.name}</span><span style="color:var(--sys-blue)">${r.count}/4</span></div>`).join('');
        });

        socket.on('waitingRoomUpdate', (r) => { currentGateID=r.id; showScreen('screen-waiting'); document.getElementById('wr-title').innerText=r.name; });
        function playerConfirm() { socket.emit('playerConfirm', { gateID: currentGateID }); }
        function leaveWaitingRoom() { socket.emit('quitGame'); showScreen('screen-menu'); }
        socket.on('gameStart', (d) => { currentGateID=d.roomId; transportAnimation(()=>showScreen('screen-game')); });
        function quitAction() { socket.emit('quitGame'); currentGateID = null; document.getElementById('victory-screen').style.display='none'; showScreen('screen-menu'); }
        socket.on('returnToProfile', () => { currentGateID = null; document.getElementById('victory-screen').style.display='none'; showScreen('screen-menu'); });

        socket.on('gameStateUpdate', (state) => {
            if(!state.active) return; currentGameState = state;
            let me = state.players.find(p => p.id === socket.id) || state.players.find(p => p.name === myHunter.username);
            
            // *** PARTICIPANT CHECK FOR POWERUP ***
            const pBtn = document.getElementById('btn-powerup');
            if (me && me.alive && me.powerUp && state.processing && state.currentBattle) {
                const isFighter = (me.id === state.currentBattle.attacker || me.id === state.currentBattle.defender);
                pBtn.style.display = isFighter ? 'block' : 'none';
                if(isFighter) { pBtn.innerText = `ACTIVATE ${me.powerUp}`; currentHunterPowerUp = me.powerUp; }
            } else { pBtn.style.display = 'none'; }

            document.getElementById('turn-indicator').innerText = (me.id === state.players[state.turn].id) ? "YOUR TURN" : "WAITING...";
            document.getElementById('ingame-party').innerHTML = state.players.map(p => `
                <div style="padding: 5px; border-bottom: 1px solid #333; margin-bottom:5px; opacity:${p.alive?1:0.3};">
                    <div style="color:${p.color}; font-weight:900;">${p.isAdmin?'üëë':''}${p.name} ${p.isStunned?'üòµ':''} ${p.powerUp ? POWER_ICONS[p.powerUp]||'‚≠ê' : ''}</div>
                    <div style="display:flex; justify-content:space-between; font-size:0.8rem;">
                        <span style="color:var(--sys-blue)">MP: ${(p.id===socket.id||(myHunter&&myHunter.isAdmin))?p.mana:p.displayRank}</span>
                    </div>
                </div>`).join('');

            const board = document.getElementById('game-board'); board.innerHTML = '';
            const range = (isMyTurn && me) ? getMoveRange(me.mana) : 0;
            const turnPlayer = state.players[state.turn];
            const isMyTurn = (me && me.id === turnPlayer.id && !state.processing);

            for(let y=0; y<15; y++) {
                for(let x=0; x<15; x++) {
                    const cell = document.createElement('div'); cell.className = 'cell';
                    const key = `${x}-${y}`;
                    if(state.world[key]) {
                        cell.style.backgroundColor = state.world[key].color;
                        if(state.world[key].rank === 'Silver') cell.classList.add('silver-monarch');
                    }
                    const p = state.players.find(pl => pl.alive && pl.x === x && pl.y === y);
                    if(p) cell.innerHTML = `<div class="humanoid"><div class="name-tag" style="color:${p.color}">${p.name}</div><div class="h-head" style="border-color:${p.color};"></div><div class="h-body" style="border-color:${p.color};"></div></div>`;
                    
                    if (isMyTurn && me && me.alive && !me.isStunned) {
                         const dx = Math.abs(me.x - x); const dy = Math.abs(me.y - y);
                         let isValid = false;
                         if (dx === 0 && dy === 0) isValid = false;
                         else if (dx > 0 && dy > 0) isValid = (dx === 1 && dy === 1); // Diagonal 1 tile
                         else isValid = ((dx + dy) <= range); // Cardinal Range
                         
                         if (isValid) { cell.classList.add('valid-move'); cell.onclick = () => socket.emit('playerAction', {tx:x, ty:y}); }
                    }
                    board.appendChild(cell);
                }
            }
        });

        socket.on('battleStart', (d) => {
            const p = document.getElementById('vs-panel'); p.style.display = 'flex';
            document.getElementById('vs-content').innerHTML = `<span style="color:${d.hunterColor}; font-weight:900;">${d.hunter}</span><br><span style="font-size:0.8rem; color:#666;">VS</span><br><span style="color:${d.targetColor}; font-weight:900;">${d.target}</span><div style="font-size:0.8rem; color:#aaa; margin-top:5px;">${d.targetRank}</div>`;
            const b = document.getElementById('vs-bar'); b.style.width = '0%';
            setTimeout(() => { b.style.transition = 'width 4.8s linear'; b.style.width = '100%'; }, 50);
        });
        socket.on('battleEnd', () => { document.getElementById('vs-panel').style.display='none'; });
        function usePowerUp() { if(currentHunterPowerUp) { socket.emit('activateSkill', {powerUp: currentHunterPowerUp}); document.getElementById('btn-powerup').style.display='none'; } }
        socket.on('announcement', (msg) => { const feed = document.getElementById('announcement-feed'); const el = document.createElement('div'); el.style.color = 'var(--sys-gold)'; el.innerText = `[SYSTEM]: ${msg}`; feed.prepend(el); });

        socket.on('victoryEvent', (data) => {
            const scr = document.getElementById('victory-screen'); scr.style.display = 'flex';
            document.getElementById('winner-name').innerText = data.winner;
            const isMe = (myHunter && myHunter.username === data.winner);
            const isOnline = currentGameState ? currentGameState.isOnline : false;
            document.getElementById('reward-info').innerText = isMe ? `REWARD: +${isOnline?20:5} HuP` : `MISSION ENDED`;
            document.getElementById('reward-info').style.color = isMe ? 'var(--rank-e)' : '#888';
        });

        function getShortRankLabel(m) { if(m >= 901) return "S-RANK"; if(m >= 701) return "A-RANK"; if(m >= 501) return "B-RANK"; if(m >= 301) return "C-RANK"; if(m >= 101) return "D-RANK"; return "E-RANK"; }
        function getMoveRange(mana) { if (mana >= 901) return 6; if (mana >= 701) return 5; if (mana >= 501) return 4; if (mana >= 301) return 3; if (mana >= 101) return 2; return 1; }
    </script>
</body>
</html>

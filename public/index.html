<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ORIGIN: MANA SIEGE</title>

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#00d2ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mana Siege">
    <link rel="apple-touch-icon" href="/assets/favicon.png">

    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '923878680532589');
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=923878680532589&ev=PageView&noscript=1"
    /></noscript>
    <link rel="icon" type="image/png" href="assets/favicon.png">
    
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@1,900&family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <style>
        /* GLOBAL RESET TO PREVENT "ZOOM OUT" BUG */
        * { box-sizing: border-box; }

        :root { 
            --sys-blue: #00d2ff; 
            --sys-gold: #ffcc00; 
            --sys-silver: #ffffff; 
            
            /* RANK COLORS */
            --rank-s: #ff0000; 
            --rank-a: #ff00ff; 
            --rank-b: #ff9900; 
            --rank-c: #ffff00; 
            --rank-d: #99ff00; 
            --rank-e: #00ff00; 
        }

        /* LOCKED VIEWPORT TO FIX MOBILE SCROLLING AND BUTTONS */
        body { 
            background: #000; 
            color: white; 
            font-family: 'Exo 2', sans-serif; 
            margin: 0; 
            overflow: hidden; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            position: fixed;
            inset: 0;
        }

        h1, h2, h3 { font-family: 'Orbitron'; font-style: italic; color: var(--sys-blue); text-shadow: 0 0 10px var(--sys-blue); margin: 5px 0; }
        
        .screen { 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start; 
            padding-top: 5vh;
            padding-bottom: 120px; /* HUGE PADDING SO BOTTOM BUTTONS ARE ALWAYS CLICKABLE */
            height: 100%; 
            width: 100%; 
            position: absolute; 
            inset: 0; 
            background: #000; 
            z-index: 10; 
            overflow-y: auto; 
            overflow-x: hidden;
        }
        .active { display: flex !important; }

        /* Unified background for all menu screens */
        #screen-auth, #screen-inventory, #screen-menu, #screen-lobby, #screen-waiting { 
            background: url('/uploads/bg/menu.png') no-repeat center center; 
            background-size: cover; 
            position: relative;
            background-attachment: fixed;
        }
        #screen-auth {
            justify-content: center; 
            padding: 0; 
        }
        #screen-auth::before, #screen-inventory::before, #screen-menu::before, #screen-lobby::before, #screen-waiting::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, rgba(0,0,0,0.5) 0%, rgba(0,0,0,0.95) 100%);
            z-index: 0;
            pointer-events: none;
        }
        #screen-auth > *, #screen-inventory > *, #screen-menu > *, #screen-lobby > *, #screen-waiting > * {
            z-index: 1;
        }
        
        #screen-game {
            flex-direction: row; 
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            padding: 0; 
            overflow: hidden;
            background-color: #000;
        }

        .sys-btn { 
            background: #000; 
            border: 2px solid var(--sys-blue); 
            color: var(--sys-blue); 
            padding: 12px 20px; 
            font-family: 'Orbitron'; 
            cursor: pointer; 
            margin: 5px; 
            font-weight: 900; 
            clip-path: polygon(10% 0, 100% 0, 90% 100%, 0 100%); 
            min-width: 150px; 
            text-transform: uppercase; 
            transition: 0.2s; 
            letter-spacing: 2px;
            font-size: 0.9rem;
            box-sizing: border-box;
        }
        .sys-btn:hover { background: var(--sys-blue); color: #000; box-shadow: 0 0 15px var(--sys-blue); }
        .sys-btn:active { transform: scale(0.95); }
        .sys-btn:disabled { opacity: 0.5; cursor: not-allowed; border-color: #444; color: #666; }
        .sys-btn:disabled:hover { background: #000; box-shadow: none; color: #666; }
        
        .sys-btn.danger { border-color: var(--rank-s); color: var(--rank-s); }
        .sys-btn.danger:hover { background: var(--rank-s); color: #000; box-shadow: 0 0 15px var(--rank-s); }
        
        .sys-btn.gold { border-color: var(--sys-gold); color: var(--sys-gold); }
        .sys-btn.gold:hover { background: var(--sys-gold); color: #000; box-shadow: 0 0 15px var(--sys-gold); }

        .sys-input { 
            padding: 15px; 
            background: rgba(0,0,0,0.8); 
            border: 1px solid var(--sys-blue); 
            color: #fff; 
            width: 80%; 
            max-width: 300px;
            margin: 10px; 
            font-family: 'Orbitron'; 
            outline: none; 
            text-align: center; 
            font-size: 1.1rem; 
            box-sizing: border-box;
        }
        .sys-input::placeholder { color: #444; }

        .profile-container { display: flex; flex-direction: row; width: 100%; max-width: 1200px; padding: 0 20px; box-sizing: border-box; height: auto; gap: 20px; }
        
        /* SCROLLABLE MENU SECTION FOR MOBILE */
        .menu-section { border: 1px solid #222; background: rgba(10,10,10,0.8); padding: 20px; display: flex; flex-direction: column; overflow-y: auto; }
        
        .social-btn { display: flex; flex-direction: column; align-items: center; text-decoration: none; font-family: 'Orbitron'; font-size: 0.7rem; font-weight: 900; transition: 0.2s; gap: 5px; opacity: 0.7; }
        .social-btn:hover { opacity: 1; transform: scale(1.1); filter: drop-shadow(0 0 10px currentColor); }

        #game-wrapper { display: flex; flex: 1; align-items: center; justify-content: center; padding: 10px; height: 100%; box-sizing: border-box; }

        #game-board { 
            display: grid; 
            grid-template-columns: repeat(15, 1fr); 
            gap: 1px; 
            background: rgba(17, 17, 17, 0.8); 
            border: 2px solid var(--sys-blue); 
            box-shadow: 0 0 20px rgba(0, 210, 255, 0.2); 
            width: 80vmin; 
            height: 80vmin;
            max-width: 650px;
            max-height: 650px;
        }

        .cell { 
            width: 100%; height: 100%; background: rgba(5, 5, 5, 0.9); position: relative; 
            border: 0.5px solid rgba(26, 26, 26, 0.5); transition: background 0.2s; 
            display: flex; justify-content: center; align-items: center;
        }
        .valid-move { box-shadow: inset 0 0 0 1px var(--sys-blue); cursor: pointer; background: rgba(0, 210, 255, 0.1); z-index: 5; }
        .valid-move:hover { background: rgba(0, 210, 255, 0.3); }

        .monolith {
            width: 50%; height: 80%; background: currentColor;
            clip-path: polygon(50% 0%, 100% 15%, 80% 100%, 20% 100%, 0% 15%);
            filter: drop-shadow(0 0 8px currentColor); position: absolute; bottom: 10%;
        }

        .silver-eagle {
            width: 80%; height: 80%; background: white;
            clip-path: polygon(50% 0%, 100% 30%, 80% 60%, 50% 100%, 20% 60%, 0% 30%);
            box-shadow: 0 0 15px white, inset 0 0 10px #ccc;
            animation: pulse-silver 1.5s infinite alternate; position: absolute; z-index: 2;
        }

        .custom-skin {
            position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%); 
            width: 80%; height: 80%; pointer-events: none; z-index: 10;
            background-size: contain; background-position: center; background-repeat: no-repeat;
            filter: drop-shadow(0 0 5px currentColor); 
        }

        .silver-eagle-glow { animation: pulse-custom-eagle 1.5s infinite alternate; }
        @keyframes pulse-custom-eagle {
            0% { filter: drop-shadow(0 0 5px white) brightness(1); }
            100% { filter: drop-shadow(0 0 15px white) brightness(1.2); }
        }
        @keyframes pulse-silver { 0% { filter: brightness(1); transform: scale(1); } 100% { filter: brightness(1.5); transform: scale(1.05); } }

        .humanoid { 
            position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%); 
            width: 60%; height: 70%; pointer-events: none; z-index: 10; 
            display: flex; flex-direction: column; align-items: center;
        }
        .h-head { width: 40%; height: 30%; border-radius: 50%; border: 1px solid white; box-shadow: 0 0 2px currentColor; background: black;}
        .h-body { width: 80%; height: 50%; border: 1px solid white; border-radius: 4px 4px 0 0; margin-top: 1px; box-shadow: 0 0 2px currentColor; background: black; }
        
        .name-tag { 
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%); 
            font-size: 0.6em; white-space: nowrap; font-weight: 900; 
            background: rgba(0,0,0,0.9); border: 1px solid #444; padding: 1px 3px; 
            z-index: 20; text-shadow: none; pointer-events: none;
        }

        /* NEW TABBED CHAT STYLES */
        .chat-container { display: flex; flex-direction: column; background: rgba(0,0,0,0.6); border: 1px solid #333; position: absolute; top: 0; left: 0; right: 0; bottom: 0; }
        .chat-tabs { display: flex; background: #111; border-bottom: 1px solid #333; }
        .chat-tab { flex: 1; padding: 5px; cursor: pointer; text-align: center; color: #888; font-size: 0.7rem; font-weight: 900; transition: 0.2s; }
        .chat-tab.active { color: var(--sys-blue); background: #222; border-bottom: 2px solid var(--sys-blue); }
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 5px; font-size: 0.8rem; font-family: 'Exo 2'; scrollbar-width: thin; height: 0; }
        .chat-messages div { margin-bottom: 2px; line-height: 1.2; word-wrap: break-word;}
        .chat-input-area { display: flex; border-top: 1px solid #333; height: 40px; flex-shrink: 0;}
        .chat-input-area input { flex-grow: 1; background: transparent; border: none; color: white; padding: 5px; outline: none; font-family: 'Exo 2'; font-size: 16px; margin: 0;}
        .chat-input-area button { background: #222; color: var(--sys-blue); border: none; padding: 0 15px; cursor: pointer; font-weight: 900; margin: 0; min-width: auto; width: auto;}

        .admin-glow { color: var(--sys-gold) !important; text-shadow: 0 0 10px var(--sys-gold); }
        .admin-msg { border-left: 2px solid var(--sys-gold); padding-left: 5px; background: rgba(255, 204, 0, 0.05); }

        #vs-panel { display: none; background: rgba(10,0,0,0.95); border: 2px solid var(--rank-s); padding: 10px; margin-bottom: 10px; flex-direction: column; align-items: center; box-shadow: 0 0 20px var(--rank-s); }
        .v-fill { height: 8px; background: var(--rank-s); width: 0%; margin-top: 10px; box-shadow: 0 0 10px var(--rank-s); }

        .rank-table { width: 100%; font-size: 0.7rem; border-collapse: collapse; color: #888; margin-top: auto; }
        .rank-table td { border-bottom: 1px solid #222; padding: 2px; }

        #transition-overlay, #matchmaking-overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; opacity: 0; transition: opacity 0.5s; }
        #transition-overlay { pointer-events: none; }
        #matchmaking-overlay { background: rgba(0,0,0,0.95); opacity: 1; pointer-events: auto; }
        .loader-ring { width: 80px; height: 80px; border: 5px solid #111; border-top: 5px solid var(--sys-blue); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #victory-screen { justify-content: center; padding: 0; background: rgba(0,0,0,0.98); z-index: 10000; text-align: center; }

        .room-item { padding: 15px; border: 1px solid #333; margin-bottom: 5px; background: rgba(0,210,255,0.05); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .room-item:hover { background: rgba(0,210,255,0.2); border-color: var(--sys-blue); }

        .hud-left { width: 300px; display: flex; flex-direction: column; height: 100%; border-right: 1px solid #333; padding: 20px; flex-shrink: 0; }
        .hud-right { width: 300px; display: flex; flex-direction: column; height: 100%; border-left: 1px solid #333; padding: 20px; flex-shrink: 0; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: var(--sys-blue); border-radius: 4px; }

        /* --- GAME EFFECTS CSS --- */
        .hidden-effect { display: none; }
        #mobile-quit-btn { display: none; } /* HIDDEN ON DESKTOP */
        
        #clash-effect-container {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 9999; pointer-events: none; text-align: center;
        }
        #powerup-effect-container {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 9999; pointer-events: none; text-align: center;
            display: flex; gap: 40px; justify-content: center; align-items: center;
        }
        #clash-animation { width: 300px; height: auto; filter: drop-shadow(0 0 10px white); }
        
        .powerup-animation-icon {
            font-size: 150px; 
            filter: drop-shadow(0 0 20px var(--sys-gold));
        }

        .clash-active {
            display: block !important;
            animation: fadeOutEffect 1s forwards;
        }
        .powerup-active {
            display: flex !important;
            animation: fadeOutEffect 1s forwards;
        }
        @keyframes fadeOutEffect {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            40% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }

        /* --- EXTREME MOBILE OPTIMIZATION --- */
        @media (max-width: 1024px) {
            h1 { font-size: 2.2rem !important; }
            h2 { font-size: 1.5rem !important; }
            
            .screen { padding: 2vh 10px 150px 10px !important; height: 100dvh !important; overflow-x: hidden !important; overflow-y: auto !important; justify-content: flex-start; } 
            
            .profile-container { flex-direction: column !important; width: 100%; gap: 15px; padding: 0 10px; }
            .menu-section { width: 100%; padding: 15px; flex: none !important; } 
            
            .lobby-header { flex-direction: row !important; width: 100% !important; margin-bottom: 10px !important; }
            .lobby-header h2 { font-size: 1.5rem !important; }
            .lobby-header button { min-width: 80px !important; padding: 8px 15px !important; margin: 0 !important; width: auto !important; }
            
            .lobby-panels { flex-direction: column !important; width: 100%; padding: 0 10px; gap: 10px; }
            .lobby-panels > div { flex: none !important; } 

            #screen-game { flex-direction: column; justify-content: flex-start; padding: 10px 0; overflow-y: auto !important; gap: 10px; }
            #game-wrapper { order: 1; width: 100%; flex: none; height: auto; display: flex; justify-content: center; padding: 0; } 
            #game-board { width: 95vmin; height: 95vmin; max-width: 650px; max-height: 650px; gap: 1px; border-width: 2px; }
            .humanoid { width: 70%; height: 80%; bottom: 10%; }
            .h-head { width: 50%; height: 40%; }
            .h-body { width: 80%; height: 50%; }
            .name-tag { font-size: 8px; top: -12px; }
            .hud-right { order: 2; width: 100%; border-left: none; border-top: 1px solid #333; padding: 10px; height: auto; flex-shrink: 1; box-sizing: border-box;}
            .hud-left { order: 3; width: 100%; border-right: none; border-top: 1px solid #333; padding: 10px; height: auto; flex-shrink: 1; box-sizing: border-box;}
            .rank-table { display: none; } 
            
            /* TARGETED QUIT BUTTON DISPLAY LOGIC FOR MOBILE */
            #desktop-quit-btn { display: none !important; }
            #mobile-quit-btn { display: block !important; order: 4; width: calc(100% - 20px) !important; margin: 20px auto 40px auto !important; flex-shrink: 0; }

            .sys-btn { width: 100% !important; margin: 5px 0 !important; box-sizing: border-box; }
            .sys-input { width: 100% !important; max-width: 100% !important; box-sizing: border-box; margin: 5px 0 !important;}
        }
    </style>
</head>
<body>

    <audio id="bgm" loop></audio>

    <div id="transition-overlay">
        <div class="loader-ring"></div>
        <h2 style="letter-spacing: 5px;">TRANSFERRING...</h2>
    </div>

    <div id="matchmaking-overlay">
        <div class="loader-ring" style="border-top-color: var(--sys-gold);"></div>
        <h2 style="color: var(--sys-gold); letter-spacing: 3px; text-shadow: 0 0 10px var(--sys-gold);">SEARCHING FOR HUNTERS...</h2>
        <div style="color:#aaa; font-family:'Orbitron'; margin-top:10px; font-weight:900;">MATCHING TIER BRACKET</div>
        <button class="sys-btn danger" style="margin-top:40px; width:200px;" onclick="cancelMatchmaking()">CANCEL</button>
    </div>

    <div id="status-modal" class="screen" style="z-index: 10000; background: rgba(0,0,0,0.95); justify-content: center; padding: 0;">
        <div style="background: #111; border: 2px solid var(--sys-gold); padding: 20px; width: 90%; max-width: 600px; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 0 30px rgba(255, 204, 0, 0.2);">
            <h3 style="color: var(--sys-gold); font-size: 1.5rem; margin-bottom: 5px; text-align: center;">SERVER STATUS</h3>
            <div id="status-count" style="text-align: center; color: var(--sys-blue); margin-bottom: 15px; font-weight: 900;">ONLINE: 0</div>
            <div id="status-list" style="flex-grow: 1; overflow-y: auto; border: 1px solid #333; padding: 10px; margin-bottom: 15px; font-size: 0.8rem; font-family: 'Exo 2';"></div>
            <button class="sys-btn danger" style="margin: 0;" onclick="closeStatusModal()">CLOSE MODULE</button>
        </div>
    </div>

    <div id="send-modal" class="screen" style="z-index: 10000; background: rgba(0,0,0,0.9); justify-content: center; padding: 0;">
        <div style="background: #111; border: 2px solid var(--sys-gold); padding: 30px; text-align: center; box-shadow: 0 0 30px rgba(255, 204, 0, 0.2); width: 90%; max-width: 400px;">
            <h3 style="color: var(--sys-gold); font-size: 1.8rem; margin-bottom: 5px;">DISPATCH ITEM</h3>
            <div id="sm-item-name" style="color: #aaa; margin-bottom: 20px; font-family:'Orbitron';"></div>
            <input type="text" id="sm-target" class="sys-input" placeholder="HUNTER USERNAME">
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-direction: column;">
                <button class="sys-btn gold" onclick="confirmSend()">SEND SECURELY</button>
                <button class="sys-btn danger" onclick="closeSendModal()">CANCEL</button>
            </div>
        </div>
    </div>

    <div id="victory-screen" class="screen">
        <h1 style="font-size: 3rem; color: var(--sys-gold); text-shadow: 0 0 30px var(--sys-gold); text-align: center;">QUEST COMPLETE</h1>
        <h2 id="winner-name" style="font-size: 2rem;">---</h2>
        <div id="reward-info" style="font-size: 1.2rem; margin: 20px 0; font-family: 'Orbitron'; font-weight:900;"></div>
        <div style="color: var(--sys-blue);">RETURNING...</div>
    </div>

    <div id="screen-auth" class="screen active">
        <h1 style="font-size: 3.5rem; letter-spacing: 5px; margin-bottom: 20px; text-align: center;">ORIGIN:<br>MANA SIEGE</h1>
        <div id="auth-msg"></div>
        <input type="text" id="u" class="sys-input" placeholder="HUNTER NAME">
        <input type="password" id="p" class="sys-input" placeholder="ACCESS KEY">
        <div style="display:flex; flex-direction: column; gap:10px; margin-top:20px; width: 100%; max-width: 400px; padding: 0 20px;">
            <button class="sys-btn" onclick="auth('login')">LOGIN</button>
            <button class="sys-btn" style="border-color:#444; color:#aaa;" onclick="auth('signup')">REGISTER</button>
            <button id="btn-install" class="sys-btn gold" style="display:none; margin-top:15px; border-color:var(--sys-gold); color:var(--sys-gold);" onclick="installApp()">â¬‡ INSTALL GAME APP</button>
        </div>
    </div>

    <div id="screen-inventory" class="screen">
        <div class="lobby-header" style="display:flex; justify-content:space-between; align-items:center; width: 100%; max-width: 1000px; padding: 0 15px; margin-bottom: 20px;">
            <h2 style="margin: 0; font-size: 2.5rem;">VAULT</h2>
            <button class="sys-btn danger" style="margin: 0; min-width: auto; width: auto; padding: 10px 20px;" onclick="showScreen('screen-menu')">BACK</button>
        </div>
        
        <div style="display:flex; gap:10px; margin-bottom: 10px; flex-wrap: wrap; justify-content: center; width: 100%; padding: 0 10px;">
            <button class="sys-btn" style="width: 45%;" onclick="renderInventory('skin')">SKINS</button>
            <button class="sys-btn" style="width: 45%;" onclick="renderInventory('bg')">BG</button>
            <button class="sys-btn" style="width: 45%;" onclick="renderInventory('eagle')">EAGLES</button>
            <button class="sys-btn" style="width: 45%;" onclick="renderInventory('music')">MUSIC</button>
        </div>
        
        <div id="inv-grid" style="display:flex; gap:15px; flex-wrap:wrap; justify-content: center; width:100%; max-width:1000px; flex-grow:1; border:1px solid #333; background: rgba(0,0,0,0.5); padding: 15px;">
        </div>
    </div>

    <div id="screen-menu" class="screen">
        <div class="profile-container">
            
            <div class="menu-section" style="flex: 1;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <div id="p-badge-container" style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <img id="p-badge-img" src="" style="width: 100px; height: 100px; object-fit: contain; filter: drop-shadow(0 0 15px var(--sys-blue));">
                        <div id="p-badge-name" style="margin-top: 10px; font-family: 'Orbitron'; font-weight: 900; letter-spacing: 1px; font-size: 0.75rem; text-transform: uppercase; text-align: center;">INITIALIZING...</div>
                    </div>
                    
                    <div style="text-align: right; flex-grow: 1;">
                        <h1 id="p-name" style="font-size: 2rem; margin: 0;">---</h1>
                        <div id="p-wr" style="color: var(--sys-gold); font-weight: 900; font-size: 1rem;">WORLD RANK #--</div>
                        <div id="p-rank" style="font-size: 1.2rem; margin: 5px 0;">---</div>
                        <div id="p-stats" style="color: #888; font-size: 0.9rem;">W: 0 | L: 0</div>
                        <div id="p-mp" style="color: var(--sys-blue); font-size: 1rem;">HuP: ---</div>
                    </div>
                </div>

                <div id="player-socials" style="display: none; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; border-top: 1px solid #333; border-bottom: 1px solid #333; padding: 15px 0;">
                    <a href="https://patreon.com/xeniegaming" target="_blank" class="social-btn" style="color: #f96854;">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M15.386.524c-4.764 0-8.64 3.876-8.64 8.64 0 4.75 3.876 8.613 8.64 8.613 4.75 0 8.614-3.864 8.614-8.613C24 4.4 20.136.524 15.386.524zM.003 23.537h4.22V.524H.003v23.013z"/></svg>
                        <span>PATREON</span>
                    </a>
                    <a href="https://web.facebook.com/profile.php?id=61588484191399" target="_blank" class="social-btn" style="color: #1877F2;">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.469h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.469h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                        <span>FACEBOOK</span>
                    </a>
                    <a href="https://www.instagram.com/originmanasiege/" target="_blank" class="social-btn" style="color: #E1306C;">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z"/></svg>
                        <span>INSTAGRAM</span>
                    </a>
                </div>

                <div id="admin-controls" style="display:none; flex-direction:column; gap:5px; margin-bottom: 20px; width: 100%;">
                    <input id="adm-kick" class="sys-input" placeholder="Kick Username">
                    <button class="sys-btn danger" onclick="doAdmin('kick')">KICK</button>
                    <input id="adm-bc" class="sys-input" placeholder="Broadcast">
                    <button class="sys-btn gold" onclick="doAdmin('broadcast')">BROADCAST</button>
                    <input id="adm-search" class="sys-input" placeholder="Spectate Player">
                    <button class="sys-btn" onclick="doAdmin('search')">SEARCH & WATCH</button>
                    <button class="sys-btn gold" style="margin-top: 10px;" onclick="doAdmin('status')">SERVER STATUS</button>
                </div>

                <div id="tutorial-video-container" style="display: none; width: 100%; margin-bottom: 20px; border: 1px solid var(--sys-blue); box-shadow: 0 0 10px rgba(0, 210, 255, 0.2); box-sizing: border-box; padding: 10px; background: rgba(0,0,0,0.8);">
                    <div style="color: var(--sys-gold); font-family: 'Orbitron'; font-weight: 900; font-size: 0.8rem; margin-bottom: 10px; text-align: center; letter-spacing: 1px;">SYSTEM TUTORIAL</div>
                    <video id="tutorial-video" src="assets/tutorial.mp4" controls playsinline style="width: 100%; height: auto; border: 1px solid #333; outline: none;"></video>
                </div>

                <div style="margin-top: auto; display: flex; flex-direction: column; gap: 10px; width: 100%;">
                    <button class="sys-btn" style="border-color:var(--sys-gold); color:var(--sys-gold);" onclick="socket.emit('requestInventoryUpdate', myHunter.username); showScreen('screen-inventory'); renderInventory('skin');">VAULT (INVENTORY)</button>
                    <button class="sys-btn gold" onclick="startAI('Eagle')">SOLO/AI</button>
                    <button id="btn-system-guide" class="sys-btn" style="border-color:var(--sys-blue); color:var(--sys-blue);" onclick="window.open('/guide.html', '_blank')">SYSTEM GUIDE</button>
                    <button class="sys-btn" onclick="openOnlineLobby()">MULTIPLAYER</button>
                    <button class="sys-btn danger" style="border-color:#444; color:#666;" onclick="doLogout()">LOGOUT</button>
                </div>
            </div>

            <div class="menu-section" style="flex: 2; display: flex; flex-direction: column;">
                <h3 style="margin-top: 0;">WORLD RANKING</h3>
                <div id="world-rank-list" style="width: 100%; height: 250px; overflow-y: auto; border-top: 2px solid var(--sys-blue); margin-top: 5px;"></div>
                
                <div style="width: 100%; height: 400px; display: flex; flex-direction: column; margin-top: 15px; position: relative;">
                    <div id="chat-global-anchor" style="position: absolute; inset: 0;"></div>
                </div>
            </div>

        </div>
    </div>

    <div id="screen-lobby" class="screen">
        <div class="lobby-header" style="display:flex; justify-content:space-between; align-items:center; width: 100%; max-width: 1200px; padding: 0 15px; margin-bottom: 10px;">
            <h2 style="margin: 0; text-align: left;">CONNECTION DECK</h2>
            <button class="sys-btn danger" style="margin: 0; min-width: auto; width: auto; padding: 8px 15px;" onclick="showScreen('screen-menu')">BACK</button>
        </div>

        <div class="lobby-panels" style="display:flex; width: 100%; max-width: 1200px; gap: 10px; flex-grow: 1;">
            <div style="flex: 2; border: 1px solid var(--sys-blue); padding: 10px; display: flex; flex-direction: column; box-sizing: border-box;">
                
                <button class="sys-btn gold" style="width: 100%; margin: 0 0 10px 0; font-size:1.1rem;" onclick="startMatchmaking()">MATCHMAKING (RANKED PVP)</button>

                <div style="display:flex; gap: 10px; margin-bottom: 10px; flex-wrap:wrap; width: 100%;">
                    <input id="room-name" class="sys-input" style="margin:0; flex-grow:1; min-width: 120px;" placeholder="ROOM NAME">
                    <input id="room-pass" class="sys-input" style="margin:0; flex-grow:1; min-width: 120px;" placeholder="PASSWORD">
                    <button class="sys-btn" style="width: 100%; margin:0;" onclick="createGate()">CREATE</button>
                </div>

                <div id="room-list" style="height: 200px; overflow-y: auto; border: 1px solid #222;"></div>
            </div>

            <div id="admin-room-panel" style="display:none; flex: 1.5; border: 1px solid var(--sys-gold); padding: 10px; flex-direction: column; background: rgba(255, 204, 0, 0.05); box-sizing: border-box;">
                <div style="color: var(--sys-gold); font-weight: 900; margin-bottom: 10px; text-align: center;">ACTIVE INSTANCES</div>
                <div id="admin-room-list" style="height: 200px; overflow-y: auto;"></div>
            </div>

            <div style="flex: 1; display: flex; flex-direction: column; min-height: 450px; position: relative;">
                <div id="chat-lobby-anchor" style="position: absolute; inset: 0;"></div>
            </div>
        </div>
    </div>

    <div id="screen-waiting" class="screen">
        <div class="lobby-header" style="display:flex; justify-content:space-between; align-items:center; width: 100%; max-width: 800px; padding: 0 15px; margin-bottom: 10px;">
            <h2 id="wr-title" style="margin: 0; text-align: left;">MONOLITH: ---</h2>
            <button class="sys-btn danger" style="margin: 0; min-width: auto; width: auto; padding: 8px 15px;" onclick="leaveWaitingRoom()">LEAVE</button>
        </div>

        <div class="lobby-panels" style="display:flex; flex-direction: column; width: 100%; max-width: 800px; padding: 0 10px; gap: 10px; flex-grow: 1;">
            <div id="wr-players" style="width: 100%; border: 1px solid var(--sys-blue); padding: 10px;"></div>
            
            <div style="width: 100%; min-height: 450px; position: relative; margin-bottom: 20px; flex-grow: 1;">
                 <div id="chat-waiting-anchor" style="position: absolute; inset: 0;"></div>
            </div>
            
            <button id="btn-ready" class="sys-btn gold" style="width: 100%; margin: 30px auto 40px auto; padding: 15px;" onclick="playerConfirm()">READY</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="hud-left">
            <h3 id="turn-indicator" style="color:var(--sys-gold); border-bottom: 1px solid #333; padding-bottom: 10px; font-size: 1rem;">INITIALIZING...</h3>
            <div id="ingame-party" style="margin-bottom: 10px; font-size: 0.8rem;"></div>
            
            <div style="flex-grow: 1; display: flex; flex-direction: column; min-height: 250px; height: 350px; position: relative;">
                <div id="chat-game-anchor" style="position: absolute; inset: 0;"></div>
            </div>
        </div>

        <div id="game-wrapper">
            <div id="game-board"></div>
        </div>

        <div class="hud-right">
            <div id="vs-panel">
                <div style="font-size: 1rem; color: var(--rank-s); font-weight: 900; letter-spacing: 2px;">COMBAT</div>
                <div id="vs-content" style="text-align: center; margin: 5px 0; font-size: 0.9rem;"></div>
                
                <button id="btn-powerup" class="sys-btn gold" style="display:none; width: 100%; margin: 5px 0; font-size: 0.8rem;" onclick="usePowerUp()">ACTIVATE RUNE</button>
                
                <div style="width: 100%; background: #222; height: 6px;"><div class="v-fill" id="vs-bar"></div></div>
            </div>

            <div style="background: #050505; border: 1px solid #222; height: 100px; padding: 5px; overflow-y: auto; margin-bottom: 10px;">
                <div id="announcement-feed" style="font-size: 0.7rem; color: #aaa;"></div>
            </div>

            <div class="rank-guide-title" style="border-bottom: 1px solid #333; margin-bottom: 5px; font-weight:900;">MP RANKING DATA</div>
            <table class="rank-table">
                <tr><td style="color:var(--rank-s)">Higher S</td><td>1000+</td></tr>
                <tr><td style="color:var(--rank-s)">Lower S</td><td>901-999</td></tr>
                <tr><td style="color:var(--rank-a)">Higher A</td><td>801-900</td></tr>
                <tr><td style="color:var(--rank-a)">Lower A</td><td>701-800</td></tr>
                <tr><td style="color:var(--rank-b)">Higher B</td><td>601-700</td></tr>
                <tr><td style="color:var(--rank-b)">Lower B</td><td>501-600</td></tr>
                <tr><td style="color:var(--rank-c)">Higher C</td><td>401-500</td></tr>
                <tr><td style="color:var(--rank-c)">Lower C</td><td>301-400</td></tr>
                <tr><td style="color:var(--rank-d)">Higher D</td><td>201-300</td></tr>
                <tr><td style="color:var(--rank-d)">Lower D</td><td>101-200</td></tr>
                <tr><td style="color:var(--rank-e)">Higher E</td><td>51-100</td></tr>
                <tr><td style="color:var(--rank-e)">Lower E</td><td>0-50</td></tr>
            </table>

            <button id="desktop-quit-btn" class="sys-btn danger" style="width: 100%; margin-top: auto;" onclick="quitAction()">QUIT QUEST</button>
        </div>
        
        <button id="mobile-quit-btn" class="sys-btn danger" onclick="quitAction()">QUIT QUEST</button>
    </div>

    <div id="chat-template" style="display:none;">
        <div class="chat-container">
            <div class="chat-tabs">
                <div class="chat-tab active" data-tab="room">WORLD / ROOM</div>
                <div class="chat-tab" data-tab="dm">DIRECT (DM)</div>
            </div>
            <div class="chat-messages chat-room-messages"></div>
            <div class="chat-messages chat-dm-messages" style="display:none;"></div>
            
            <div class="chat-input-area chat-room-input">
                <input type="text" placeholder="TRANSMIT TO ROOM...">
                <button>SEND</button>
            </div>
            <div class="chat-input-area chat-dm-input" style="display:none;">
                <input type="text" class="dm-target" placeholder="TARGET USER..." style="width: 45%; min-width: 120px; border-right: 1px solid #333; flex-grow: 0;">
                <input type="text" class="dm-msg" placeholder="MESSAGE...">
                <button>SEND</button>
            </div>
        </div>
    </div>

    <div id="clash-effect-container" class="hidden-effect">
        <img src="assets/sword-clash.gif" id="clash-animation" alt="Sword Clash" onerror="this.src='https://via.placeholder.com/300x300.png?text=Sword+Clash+GIF'" />
    </div>

    <div id="powerup-effect-container" class="hidden-effect">
        </div>

    <script>
        const RENDER_URL = "https://originmanaseige.onrender.com";
        
        let localDeviceID = localStorage.getItem('hunter_device_id');
        if (!localDeviceID) {
            localDeviceID = 'dev_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('hunter_device_id', localDeviceID);
        }
        
        const socket = io(RENDER_URL, { query: { deviceId: localDeviceID } });

        let myHunter = null, myRoomID = 'profile_page', currentBGM = "", currentGateID = null, currentInvTab = 'skin';
        let currentHunterPowerUp = null, currentGameState = null, currentWorldRankings = [];
        const BGM = document.getElementById('bgm');

        const POWER_ICONS = { 'DOUBLE DAMAGE': 'âš”ï¸', 'AIR WALK': 'ðŸ‘£', 'SOUL SWAP': 'ðŸŒ€', 'RULERS POWER': 'ðŸ‘‘', '?': 'â“' };

        class GameEffectsManager {
            constructor() {
                this.clashSound = new Audio('assets/sounds/sword-clash.mp3');
                this.silverEagleSound = new Audio('assets/sounds/whirling-loop.mp3');
                this.silverEagleSound.loop = true;
                
                this.clashContainer = document.getElementById('clash-effect-container');
                this.powerupContainer = document.getElementById('powerup-effect-container');
                this.eagleActive = false;
                
                this.powerupClearTimeout = null;
            }
            
            triggerCombatEffect() {
                this.clashSound.currentTime = 0;
                this.clashSound.play().catch(e => console.log("Audio interaction needed:", e));
                if (this.clashContainer) {
                    this.clashContainer.classList.remove('clash-active');
                    void this.clashContainer.offsetWidth;
                    this.clashContainer.classList.add('clash-active');
                    setTimeout(() => { this.clashContainer.classList.remove('clash-active'); }, 1000);
                }
            }
            
            triggerPowerUpEffect(powerUpName, hunterName) {
                this.playSparkleSound();
                
                if (this.clashContainer) {
                    this.clashContainer.classList.remove('clash-active');
                }

                const iconSymbol = POWER_ICONS[powerUpName] || 'â­';
                
                const wrapper = document.createElement('div');
                wrapper.style.display = 'flex';
                wrapper.style.flexDirection = 'column';
                wrapper.style.alignItems = 'center';

                const iconElement = document.createElement('div');
                iconElement.className = 'powerup-animation-icon';
                iconElement.innerText = iconSymbol;
                
                const nameElement = document.createElement('div');
                nameElement.innerText = hunterName || 'UNKNOWN';
                nameElement.style.color = '#fff';
                nameElement.style.fontFamily = 'Orbitron';
                nameElement.style.fontWeight = '900';
                nameElement.style.fontSize = '1.5rem';
                nameElement.style.textShadow = '0 0 10px var(--sys-gold), 0 0 20px var(--sys-gold)';
                nameElement.style.marginTop = '10px';
                nameElement.style.textTransform = 'uppercase';

                wrapper.appendChild(iconElement);
                wrapper.appendChild(nameElement);

                if (this.powerupContainer) {
                    if (!this.powerupContainer.classList.contains('powerup-active')) {
                         this.powerupContainer.innerHTML = ''; 
                    }
                    
                    this.powerupContainer.appendChild(wrapper);
                    
                    this.powerupContainer.classList.remove('powerup-active');
                    void this.powerupContainer.offsetWidth;
                    this.powerupContainer.classList.add('powerup-active');

                    if(this.powerupClearTimeout) clearTimeout(this.powerupClearTimeout);
                    
                    this.powerupClearTimeout = setTimeout(() => { 
                        this.powerupContainer.classList.remove('powerup-active'); 
                        this.powerupContainer.innerHTML = '';
                    }, 1000);
                }
            }

            playSparkleSound() {
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (!AudioContext) return;
                    const ctx = new AudioContext();
                    
                    const freqs = [880, 1108, 1318]; 
                    freqs.forEach((freq, i) => {
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        osc.type = 'sine';
                        osc.frequency.value = freq;
                        
                        const startTime = ctx.currentTime + (i * 0.05);
                        gain.gain.setValueAtTime(0, startTime);
                        gain.gain.linearRampToValueAtTime(0.3, startTime + 0.02);
                        gain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.3);
                        
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        osc.start(startTime);
                        osc.stop(startTime + 0.3);
                    });
                } catch(e) {}
            }

            startSilverEaglePresence() {
                if(!this.eagleActive) {
                    this.silverEagleSound.play().catch(e => console.log("Audio interaction needed:", e));
                    this.eagleActive = true;
                }
            }
            
            stopSilverEaglePresence() {
                if(this.eagleActive) {
                    this.silverEagleSound.pause();
                    this.silverEagleSound.currentTime = 0;
                    this.eagleActive = false;
                }
            }
        }
        const fxManager = new GameEffectsManager();

        function playDMSound() {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.5, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + 0.1);
            } catch(e) {}
        }

        // EDITED: Updated the list of recognized native BGM tracks to include victory.mp3 and lose.mp3
        function playTrack(name) {
            if(!name || currentBGM === name) return;
            currentBGM = name;
            BGM.src = (name === 'login.mp3' || name === 'menu.mp3' || name === 'waiting.mp3' || name === 'gameplay.mp3' || name === 'victory.mp3' || name === 'lose.mp3') ? `/music/${name}` : `/uploads/music/${name}`;
            BGM.play().catch(()=>{});
        }

        function auth(type) {
            const u = document.getElementById('u').value, p = document.getElementById('p').value;
            if(u && p) {
                currentPass = p;
                socket.emit('authRequest', { type, u, p });
            } else {
                document.getElementById('auth-msg').innerText = "ENTER CREDENTIALS";
            }
        }

        window.onload = function() {
            playTrack('login.mp3');
            const startAudio = () => {
                if(currentBGM === 'login.mp3' && BGM.paused) {
                    BGM.play().catch(()=>{});
                }
                document.removeEventListener('click', startAudio);
            };
            document.addEventListener('click', startAudio);

            // --- TUTORIAL VIDEO AUDIO FIX ---
            const tutorialVideo = document.getElementById('tutorial-video');
            if (tutorialVideo) {
                tutorialVideo.addEventListener('play', () => { 
                    BGM.pause(); 
                });
                tutorialVideo.addEventListener('pause', () => { 
                    if(document.getElementById('screen-menu').classList.contains('active')) {
                        BGM.play().catch(()=>{}); 
                    }
                });
                tutorialVideo.addEventListener('ended', () => { 
                    if(document.getElementById('screen-menu').classList.contains('active')) {
                        BGM.play().catch(()=>{}); 
                    }
                });
            }

            const stored = sessionStorage.getItem('hunter_creds');
            if(stored) {
                try {
                    const c = JSON.parse(stored);
                    if(c.u && c.p) {
                        document.getElementById('u').value = c.u;
                        document.getElementById('p').value = c.p;
                        currentPass = c.p;
                        socket.emit('authRequest', { type: 'login', u: c.u, p: c.p });
                    }
                } catch(e) {}
            }
        };

        function doLogout() {
            currentGateID = null; 
            fxManager.stopSilverEaglePresence();
            sessionStorage.removeItem('hunter_creds');
            sessionStorage.removeItem('last_screen');
            location.reload();
        }

        socket.on('authError', (msg) => { 
            document.getElementById('auth-msg').innerText = msg;
            if(msg.includes('MULTIPLE') || msg.includes('DEVICE')) { alert(msg); window.location.href = "about:blank"; } 
            else if(msg.includes('ALREADY')) { alert(msg); location.reload(); }
        });

        socket.on('forceKick', () => {
            sessionStorage.removeItem('hunter_creds');
            sessionStorage.removeItem('last_screen');
            document.body.innerHTML = `
                <div style="display:flex; justify-content:center; align-items:center; height:100vh; background:#000; color:red; flex-direction:column; text-align:center;">
                    <h1 style="font-size:3rem; color:red; text-shadow:0 0 20px red;">YOU HAVE BEEN KICKED BY THE ADMIN</h1>
                    <p style="font-family:'Orbitron';">CONNECTION TERMINATED FORCEFULLY</p>
                    <button class="sys-btn danger" onclick="location.reload()">ACKNOWLEDGE</button>
                </div>`;
        });

        socket.on('authSuccess', (d) => {
            // META PIXEL TRACKING: Tells Meta "A new Hunter has joined the Siege!"
            if (typeof fbq !== 'undefined') {
                fbq('track', 'CompleteRegistration', { content_name: 'Origin: Mana Siege' });
            }

            myHunter = d;
            sessionStorage.setItem('hunter_creds', JSON.stringify({u: d.username, p: currentPass}));
            document.getElementById('p-name').innerText = d.username;
            document.getElementById('p-name').className = d.isAdmin ? 'admin-glow' : '';
            document.getElementById('p-rank').innerText = d.rank;
            document.getElementById('p-rank').style.color = d.color;
            document.getElementById('p-mp').innerText = `HuP: ${d.mana}`;
            document.getElementById('p-stats').innerText = `W: ${d.wins || 0} | L: ${d.losses || 0}`;
            document.getElementById('p-wr').innerText = `WORLD RANK #${d.worldRank || '--'}`;

            const badgeData = {
                'E': { title: 'Beginner Hunter', file: 'badge_E.png' },
                'D': { title: 'Novice Hunter', file: 'badge_D.png' },
                'C': { title: 'Elite Hunter', file: 'badge_C.png' },
                'B': { title: 'Veteran Hunter', file: 'badge_B.png' },
                'A': { title: 'Super Hunter', file: 'badge_A.png' },
                'S': { title: 'Master Hunter', file: 'badge_S.png' },
                'S+': { title: 'Lord of Hunters', file: 'badge_Splus.png' }
            };

            const rankInfo = getRankLetter(d.mana); 
            let cleanLetter = rankInfo.letter.replace('-', '').replace('+', ''); 
            if (rankInfo.letter === "S+") cleanLetter = "S+"; 

            const currentBadge = badgeData[cleanLetter] || badgeData['E'];

            const badgeImg = document.getElementById('p-badge-img');
            const badgeName = document.getElementById('p-badge-name');
            
            badgeImg.src = `/uploads/badges/${currentBadge.file}`;
            badgeImg.style.filter = `drop-shadow(0 0 15px ${rankInfo.color})`;
            badgeName.innerText = currentBadge.title;
            badgeName.style.color = rankInfo.color;
            badgeName.style.textShadow = `0 0 10px ${rankInfo.color}`;
            
            // DYNAMIC TUTORIAL VIDEO TOGGLE
            const tutorialContainer = document.getElementById('tutorial-video-container');
            if (tutorialContainer) {
                if (rankInfo.letter === "E-") {
                    tutorialContainer.style.display = 'block';
                } else {
                    tutorialContainer.style.display = 'none';
                }
            }

            if (d.isAdmin) {
                document.getElementById('admin-controls').style.display = 'flex';
                document.getElementById('admin-room-panel').style.display = 'flex';
                document.getElementById('player-socials').style.display = 'none';
                document.getElementById('btn-system-guide').style.display = 'none';
            } else {
                document.getElementById('admin-controls').style.display = 'none';
                document.getElementById('admin-room-panel').style.display = 'none';
                document.getElementById('player-socials').style.display = 'flex';
                document.getElementById('btn-system-guide').style.display = 'block';
            }

            if (!d.reconnected) {
                const currentScreen = document.querySelector('.screen.active').id;
                if(currentScreen !== 'screen-game') {
                    const lastScreen = sessionStorage.getItem('last_screen');
                    if(lastScreen && !['screen-game', 'screen-waiting', 'screen-auth'].includes(lastScreen)) {
                        showScreen(lastScreen);
                    } else {
                        showScreen('screen-menu');
                    }
                }
            }
            if(d.music) playTrack(d.music);
        });

        function closeStatusModal() { document.getElementById('status-modal').style.display = 'none'; }
        
        socket.on('adminStatusResponse', (data) => {
            document.getElementById('status-count').innerText = `TOTAL ONLINE HUNTERS: ${data.total}`;
            const listEl = document.getElementById('status-list');
            listEl.innerHTML = data.players.map(p => `
                <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #222;">
                    <span style="color: #fff; font-weight: bold; font-family: 'Orbitron';">${p.name}</span>
                    <span style="color: var(--sys-gold);">${p.location}</span>
                </div>
            `).join('');
            document.getElementById('status-modal').style.display = 'flex';
        });

        let sendItemData = null;
        function openSendModal(type, item) {
            sendItemData = { type, item };
            document.getElementById('sm-item-name').innerText = item.toUpperCase();
            document.getElementById('sm-target').value = '';
            document.getElementById('send-modal').style.display = 'flex';
        }
        function closeSendModal() { document.getElementById('send-modal').style.display = 'none'; }
        function confirmSend() {
            const target = document.getElementById('sm-target').value.trim();
            if (target && sendItemData) {
                socket.emit('adminAction', { action: 'grantItem', target: target, item: `${sendItemData.type}:${sendItemData.item}` });
                closeSendModal();
            }
        }

        function renderInventory(type) {
            currentInvTab = type;
            const grid = document.getElementById('inv-grid');
            grid.innerHTML = '';
            
            const allItems = myHunter.inventory || [];
            const ownedItems = myHunter.ownedItems || [];
            
            const itemsInTab = allItems.filter(i => i.startsWith(type + ':')).map(i => i.split(':')[1]);
            
            if (itemsInTab.length === 0) {
                grid.innerHTML = `<div style="color:#888; width:100%; text-align:center; margin-top:20px;">NO ITEMS FOUND IN SERVER FOLDER.</div>`;
                return;
            }

            const unlockReqs = {
                'char_knight.png': 'REACH RANK D',
                'char_calvary.png': 'REACH RANK C',
                'char_assasin.png': 'REACH RANK B',
                'char_sniper.png': 'REACH RANK A',
                'eagle_premium.png': 'REACH RANK A',
                'char_speargirl.png': 'REACH RANK S',
                'hunterseige_bg.png': 'REACH RANK S',
                'char_main char.png': 'REACH RANK S+',
                'Pixel Parlor Lounge.mp3': 'REACH RANK S+',
                'char_queen.png': 'REACH TOP 3 WORLD RANK',
                'char_king.png': 'REACH TOP 1 WORLD RANK'
            };

            itemsInTab.forEach(item => {
                const invString = `${type}:${item}`;
                const isOwned = myHunter.isAdmin || ownedItems.includes(invString);
                const isEquipped = myHunter.activeCosmetics && myHunter.activeCosmetics[type] === item;

                const box = document.createElement('div');
                box.style = `
                    width: 120px; height: 180px; display:flex; flex-direction:column; align-items:center; padding:5px; background: rgba(0,0,0,0.8); position: relative;
                    border: 2px solid ${isEquipped ? 'var(--sys-gold)' : (isOwned ? '#444' : '#222')};
                    opacity: ${isOwned ? '1' : '0.6'};
                `;
                
                let preview = '';
                if (type === 'music') preview = `<div style="font-size:3rem; margin:auto;">ðŸŽµ</div>`;
                else {
                    let folder = (type === 'bg') ? 'bg' : 'skins';
                    preview = `<img src="/uploads/${folder}/${item}" style="max-width:100%; max-height:80px; margin:auto; object-fit:contain; filter: ${isOwned ? 'none' : 'grayscale(100%) brightness(0.3)'};">`;
                }

                let padlock = '';
                if (!isOwned) {
                    let reqMessage = unlockReqs[item] || 'VANGUARD / ADMIN';
                    padlock = `
                        <div style="position:absolute; top:35%; width: 100%; text-align: center; font-size:0.6rem; font-family:'Orbitron'; font-weight:900; color:var(--rank-s); text-shadow:0 0 5px black, 0 0 5px black; z-index:5; background: rgba(0,0,0,0.7); padding: 5px 0;">
                            ðŸ”’<br>UNLOCK:<br>${reqMessage}
                        </div>`;
                }

                let buttonLabel = "LOCKED";
                let buttonClass = "";
                let buttonDisable = "disabled";

                if (isOwned) {
                    buttonLabel = isEquipped ? "UNEQUIP" : "EQUIP";
                    buttonClass = isEquipped ? "gold" : "";
                    buttonDisable = "";
                }

                let buttonsHTML = `<button class="sys-btn ${buttonClass}" style="min-width:0; width:100%; padding:5px; font-size:0.7rem; margin-top:auto;" onclick="equipItem('${type}', '${item}')" ${buttonDisable}>${buttonLabel}</button>`;
                
                if (myHunter.isAdmin) {
                    buttonsHTML += `<button class="sys-btn danger" style="min-width:0; width:100%; padding:5px; font-size:0.7rem; margin-top:5px; border-color:#888;" onclick="openSendModal('${type}', '${item}')">SEND ITEM</button>`;
                }

                box.innerHTML = `
                    ${padlock}
                    ${preview}
                    <div style="font-size:0.6rem; margin-top:5px; word-break:break-all; text-align:center;">${item.replace('.png','').replace('.mp3','')}</div>
                    ${buttonsHTML}
                `;
                grid.appendChild(box);
            });
        }

        function equipItem(type, item) { socket.emit('equipItem', { username: myHunter.username, type, item }); }

        socket.on('inventoryUpdate', (data) => {
            myHunter.inventory = data.inventory;
            myHunter.ownedItems = data.ownedItems;
            myHunter.activeCosmetics = data.activeCosmetics;
            if (document.getElementById('screen-inventory').classList.contains('active')) {
                renderInventory(currentInvTab);
            }
        });

        let chatElement = null;
        function initChat() {
            const tpl = document.getElementById('chat-template');
            chatElement = tpl.firstElementChild.cloneNode(true);
            
            const tabRoom = chatElement.querySelector('.chat-tab[data-tab="room"]');
            const tabDM = chatElement.querySelector('.chat-tab[data-tab="dm"]');
            const msgRoom = chatElement.querySelector('.chat-room-messages');
            const msgDM = chatElement.querySelector('.chat-dm-messages');
            const inputRoom = chatElement.querySelector('.chat-room-input');
            const inputDM = chatElement.querySelector('.chat-dm-input');

            tabRoom.onclick = () => {
                tabRoom.classList.add('active'); tabDM.classList.remove('active');
                msgRoom.style.display = 'block'; msgDM.style.display = 'none';
                inputRoom.style.display = 'flex'; inputDM.style.display = 'none';
                msgRoom.scrollTop = msgRoom.scrollHeight;
                tabRoom.style.color = ''; 
            };

            tabDM.onclick = () => {
                tabDM.classList.add('active'); tabRoom.classList.remove('active');
                msgDM.style.display = 'block'; msgRoom.style.display = 'none';
                inputDM.style.display = 'flex'; inputRoom.style.display = 'none';
                msgDM.scrollTop = msgDM.scrollHeight;
                tabDM.style.color = ''; 
            };

            const btnRoom = inputRoom.querySelector('button');
            const inpRoom = inputRoom.querySelector('input');
            const sendRoom = () => {
                if (inpRoom.value.trim() && myHunter) {
                    socket.emit('sendMessage', { 
                        message: inpRoom.value, senderName: myHunter.username, 
                        roomId: myRoomID, rank: (myHunter.mana) ? getShortRankLabel(myHunter.mana) : 'Rank ?'
                    });
                    inpRoom.value = '';
                }
            };
            btnRoom.onclick = sendRoom;
            inpRoom.onkeydown = (e) => { if(e.key === 'Enter') sendRoom(); };

            const btnDM = inputDM.querySelector('button');
            const targetDM = inputDM.querySelector('.dm-target');
            const msgInpDM = inputDM.querySelector('.dm-msg');
            const sendDM = () => {
                if (targetDM.value.trim() && msgInpDM.value.trim() && myHunter) {
                    socket.emit('sendDM', {
                        target: targetDM.value.trim(),
                        message: msgInpDM.value,
                        senderName: myHunter.username
                    });
                    msgInpDM.value = '';
                }
            };
            btnDM.onclick = sendDM;
            msgInpDM.onkeydown = (e) => { if(e.key === 'Enter') sendDM(); };
        }
        initChat();

        function moveChatTo(anchorId, roomId) {
            myRoomID = roomId;
            socket.emit('joinChatRoom', roomId);
            const anchor = document.getElementById(anchorId);
            chatElement.querySelector('.chat-room-messages').innerHTML = ''; 
            anchor.appendChild(chatElement);
        }

        socket.on('receiveMessage', (data) => {
            const box = chatElement.querySelector('.chat-room-messages');
            const line = document.createElement('div');
            if (data.isAdmin) line.classList.add('admin-msg');
            line.innerHTML = `<span style="color:#aaa; font-size:0.7em;">[${data.timestamp}]</span> 
                              <span style="color:${data.isAdmin ? 'var(--sys-gold)' : 'var(--sys-blue)'}; font-weight:900;">
                                ${data.isAdmin?'ðŸ‘‘':''}${data.sender}
                              </span>: <span style="color:#fff;">${data.text}</span>`;
            box.appendChild(line);
            box.scrollTop = box.scrollHeight;
        });

        socket.on('receiveDM', (data) => {
            const msgDM = chatElement.querySelector('.chat-dm-messages');
            const tabDM = chatElement.querySelector('.chat-tab[data-tab="dm"]');
            const line = document.createElement('div');
            
            let color = 'var(--rank-a)'; 
            let prefix = (data.sender === myHunter.username) ? `TO [${data.target}]` : `FROM [${data.sender}]`;
            
            line.innerHTML = `<span style="color:#aaa; font-size:0.7em;">[${data.timestamp}]</span> 
                              <span style="color:${color}; font-weight:900;">${prefix}</span>: 
                              <span style="color:#fff;">${data.text}</span>`;
            msgDM.appendChild(line);
            msgDM.scrollTop = msgDM.scrollHeight;

            if (data.sender !== myHunter.username) {
                playDMSound(); 
                if (!tabDM.classList.contains('active')) {
                    tabDM.style.color = color; 
                }
            }
        });

        socket.on('updateAdminRoomList', (l) => {
            const el = document.getElementById('admin-room-list');
            if(!el) return;
            el.innerHTML = l.map(r => `
                <div class="room-item" style="border-color: var(--sys-gold); display:flex; justify-content:space-between; align-items:center; background: rgba(255, 204, 0, 0.05);" onclick="spectateAsAdmin('${r.id}')">
                    <div>
                        <span style="color:var(--sys-gold); font-weight:bold;">${r.isOnline ? (r.isRanked ? 'RANKED' : 'UNRANKED') : 'SOLO AI'}</span> |
                        <span style="color:#fff;">${r.name}</span>
                        <div style="font-size:0.7rem; color:#aaa; margin-top:3px;">PLAYERS: ${r.players}</div>
                    </div>
                    <button class="sys-btn gold" style="min-width: auto; padding: 5px 10px; font-size: 0.7rem; margin:0;">SPECTATE</button>
                </div>
            `).join('');
        });

        function spectateAsAdmin(roomId) {
            if (confirm('SPECTATE THIS ACTIVE INSTANCE?')) {
                socket.emit('spectateRoom', roomId);
                currentGateID = roomId;
                transportAnimation(() => { showScreen('screen-game'); });
            }
        }

        socket.on('adminSearchResponse', (data) => {
            if (!data.found) { alert("SYSTEM: " + data.message); return; }
            if (confirm(`TARGET LOCATED: ${data.roomName}\nPLAYERS: ${data.players.length}/4\nSPECTATE MATCH?`)) {
                socket.emit('spectateRoom', data.roomId);
                currentGateID = data.roomId;
                transportAnimation(() => { showScreen('screen-game'); });
            }
        });

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id !== 'screen-auth') sessionStorage.setItem('last_screen', id);

            if (id === 'screen-menu') { 
                playTrack('menu.mp3'); 
                moveChatTo('chat-global-anchor', 'profile_page'); 
                socket.emit('requestWorldRankings'); 
            }
            else if (id === 'screen-lobby') moveChatTo('chat-lobby-anchor', 'lobby_main');
            else if (id === 'screen-waiting') moveChatTo('chat-waiting-anchor', currentGateID);
            else if (id === 'screen-game') { moveChatTo('chat-game-anchor', currentGateID); } 
        }

        function transportAnimation(callback) {
            const overlay = document.getElementById('transition-overlay');
            overlay.style.display = 'flex';
            setTimeout(() => overlay.style.opacity = 1, 10);
            setTimeout(() => {
                callback();
                setTimeout(() => {
                    overlay.style.opacity = 0;
                    setTimeout(() => overlay.style.display = 'none', 500);
                }, 1000);
            }, 1500);
        }

        function getRankLetter(hup) {
            if (hup >= 1000) return { letter: "S+", color: "var(--rank-s)" }; 
            if (hup >= 901) return { letter: "S-", color: "var(--rank-s)" };
            if (hup >= 801) return { letter: "A+", color: "var(--rank-a)" };
            if (hup >= 701) return { letter: "A-", color: "var(--rank-a)" };
            if (hup >= 601) return { letter: "B+", color: "var(--rank-b)" };
            if (hup >= 501) return { letter: "B-", color: "var(--rank-b)" };
            if (hup >= 401) return { letter: "C+", color: "var(--rank-c)" };
            if (hup >= 301) return { letter: "C-", color: "var(--rank-c)" };
            if (hup >= 201) return { letter: "D+", color: "var(--rank-d)" };
            if (hup >= 101) return { letter: "D-", color: "var(--rank-d)" };
            if (hup >= 51) return { letter: "E+", color: "var(--rank-e)" };
            return { letter: "E-", color: "var(--rank-e)" };
        }

        function renderRankings() {
            const el = document.getElementById('world-rank-list');
            if(!el) return;
            const safeList = currentWorldRankings || []; 
            el.innerHTML = safeList.slice(0, 15).map((u, i) => {
                const rankData = getRankLetter(u.hunterpoints);
                const total = (u.wins || 0) + (u.losses || 0);
                const ratio = total > 0 ? Math.round(((u.wins || 0) / total) * 100) : 0;
                
                return `
                <div style="padding: 10px; border-bottom: 1px solid #222; display:flex; justify-content:space-between; align-items: center; font-family: 'Exo 2';">
                    <div style="display:flex; align-items: center; gap: 8px;">
                        <span style="color:${u.worldRank <= 3 ? 'var(--sys-gold)' : '#fff'}; font-weight: 900; font-size: 0.9rem;">
                            #${u.worldRank} ${u.username} ${u.isAdmin ? 'ðŸ‘‘' : ''}
                        </span>
                        <span style="color:${rankData.color}; font-weight: 900; font-size: 1rem; border: 1px solid ${rankData.color}; padding: 0 4px; border-radius: 3px; background: rgba(0,0,0,0.5);">
                            ${rankData.letter}
                        </span>
                    </div>
                    <div style="text-align: right;">
                        <span style="color: #666; font-size: 0.8rem; margin-right: 15px;">
                            W: ${u.wins || 0} | L: ${u.losses || 0} (WR: ${ratio}%)
                        </span>
                        <span style="color:#fff; font-weight: 900; font-size: 1.1rem; width: 90px; display: inline-block;">
                            ${u.hunterpoints} HuP
                        </span>
                    </div>
                </div>`;
            }).join('');
        }
        
        socket.on('updateWorldRankings', (l) => { currentWorldRankings = l; renderRankings(); });
        
        function doAdmin(action) {
            if (action === 'kick') socket.emit('adminAction', { action: 'kick', target: document.getElementById('adm-kick').value });
            if (action === 'broadcast') socket.emit('adminAction', { action: 'broadcast', message: document.getElementById('adm-bc').value });
            if (action === 'search') socket.emit('adminAction', { action: 'search', target: document.getElementById('adm-search').value });
            if (action === 'status') socket.emit('adminAction', { action: 'status' });
        }

        function openOnlineLobby() { if(!myHunter) return; showScreen('screen-lobby'); socket.emit('requestGateList'); }
        
        function createGate() { 
            const name = document.getElementById('room-name').value; 
            const pass = document.getElementById('room-pass').value;
            if (name) socket.emit('createGate', { host: myHunter.username, name, password: pass, cosmetics: myHunter.activeCosmetics }); 
        }

        function startMatchmaking() {
            document.getElementById('matchmaking-overlay').style.display = 'flex';
            socket.emit('enterMatchmakingPool');
        }
        function cancelMatchmaking() {
            document.getElementById('matchmaking-overlay').style.display = 'none';
            socket.emit('leaveMatchmakingPool');
        }
        socket.on('matchFound', (roomData) => {
            document.getElementById('matchmaking-overlay').style.display = 'none';
            currentGateID = roomData.id;
            showScreen('screen-waiting');
        });
        socket.on('matchmakingRejoined', () => {
            document.getElementById('matchmaking-overlay').style.display = 'flex';
            showScreen('screen-lobby'); 
        });

        socket.on('updateGateList', (list) => {
            const el = document.getElementById('room-list');
            el.innerHTML = list.map(r => `
                <div class="room-item" onclick="joinRoomPrompt('${r.id}', ${r.hasPassword})">
                    <span>${r.hasPassword ? 'ðŸ”’ ' : ''}${r.name} ${myHunter.isAdmin ? `<small style="color:red">[${r.id}]</small>` : ''}</span>
                    <span style="color:var(--sys-blue)">${r.count}/4</span>
                </div>
            `).join('');
        });

        function joinRoomPrompt(gateID, hasPassword) {
            let pass = null;
            if (hasPassword) {
                pass = prompt("ENTER ROOM PASSWORD TO JOIN:");
                if (pass === null) return; 
            }
            socket.emit('joinGate', { gateID: gateID, user: myHunter.username, cosmetics: myHunter.activeCosmetics, password: pass });
        }

        socket.on('waitingRoomUpdate', (room) => {
            currentGateID = room.id;
            if (!document.getElementById('screen-waiting').classList.contains('active')) showScreen('screen-waiting');
            document.getElementById('wr-title').innerText = `MONOLITH: ${room.name}`;
            const el = document.getElementById('wr-players');
            el.innerHTML = room.players.map(p => `<div style="padding: 10px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;"><span style="color:${p.color}; font-weight:900;">${p.isAdmin?'ðŸ‘‘':''}${p.name}</span><span style="font-size: 0.8rem; color: #888;">${p.worldRankLabel || ''}</span><span style="color:${p.confirmed ? 'var(--rank-e)' : '#444'}">${p.confirmed ? 'READY' : 'WAITING'}</span></div>`).join('');
            const me = room.players.find(p => p.name === myHunter.username);
            const btn = document.getElementById('btn-ready');
            if (me && me.confirmed) { btn.innerText = "WAITING..."; btn.style.opacity = 0.5; btn.disabled = true; } 
            else { btn.innerText = "READY"; btn.style.opacity = 1; btn.disabled = false; }
        });

        function playerConfirm() { if(currentGateID) socket.emit('playerConfirm', { gateID: currentGateID }); }
        
        function leaveWaitingRoom() { 
            socket.emit('quitGame'); 
            showScreen('screen-lobby'); 
            socket.emit('requestGateList'); 
        }

        function startAI(diff) { transportAnimation(() => { socket.emit('startSoloAI', { user: myHunter.username, diff, cosmetics: myHunter.activeCosmetics }); }); }
        socket.on('gameStart', (data) => { currentGateID = data.roomId; transportAnimation(() => { showScreen('screen-game'); }); });
        
        function quitAction() { 
            socket.emit('quitGame'); 
            currentGateID = null; 
            document.getElementById('victory-screen').style.display = 'none'; 
            fxManager.stopSilverEaglePresence();
            showScreen('screen-menu'); 
        }

        socket.on('returnToProfile', () => { currentGateID = null; document.getElementById('victory-screen').style.display = 'none'; fxManager.stopSilverEaglePresence(); showScreen('screen-menu'); document.getElementById('screen-game').style.backgroundImage = 'none';});

        socket.on('gameStateUpdate', (state) => {
            if (!state.active) return;
            currentGameState = state;
            let me = state.players.find(p => p.id === socket.id) || state.players.find(p => p.name === myHunter.username);
            const turnPlayer = state.players[state.turn];
            const isMyTurn = (me && me.id === turnPlayer.id && !state.processing);
            const ind = document.getElementById('turn-indicator');
            
            if(turnPlayer.isStunned) { ind.innerText = `>> ${turnPlayer.name.toUpperCase()} IS STUNNED (SKIP)`; ind.style.color = '#888'; } 
            else { ind.innerText = isMyTurn ? ">> YOUR TURN" : `>> ${turnPlayer.name.toUpperCase()}'S TURN`; ind.style.color = turnPlayer.color; }

            if (state.hostCosmetics?.bg) {
                document.getElementById('screen-game').style.backgroundImage = `url('/uploads/bg/${state.hostCosmetics.bg}')`;
                document.getElementById('screen-game').style.backgroundSize = 'cover';
                document.getElementById('screen-game').style.backgroundPosition = 'center';
            } else {
                document.getElementById('screen-game').style.backgroundImage = 'none';
            }
            playTrack(state.hostCosmetics?.music || 'gameplay.mp3');

            const pBtn = document.getElementById('btn-powerup');
            if (me && me.alive && me.powerUp && state.processing && state.currentBattle) {
                const isFighter = (me.id === state.currentBattle.attacker || me.id === state.currentBattle.defender);
                const isPvP = state.currentBattle.defender !== 'monolith'; 
                if (isFighter && isPvP) {
                     pBtn.style.display = 'block';
                     pBtn.innerText = `ACTIVATE ${me.powerUp}`;
                     currentHunterPowerUp = me.powerUp; 
                } else { pBtn.style.display = 'none'; }
            } else { pBtn.style.display = 'none'; }

            document.getElementById('ingame-party').innerHTML = state.players.map(p => `
                <div style="padding: 5px; border-bottom: 1px solid #333; margin-bottom:5px; opacity:${p.alive?1:0.3};">
                    <div style="color:${p.color}; font-weight:900;">${p.isAdmin?'ðŸ‘‘':''}${p.name} ${p.isStunned?'ðŸ˜µ':''} ${p.powerUp ? (POWER_ICONS[p.powerUp] || 'â­') : ''}</div>
                    <div style="display:flex; justify-content:space-between; font-size:0.8rem;">
                        <span>${p.worldRankLabel || ''}</span>
                        <span style="color:var(--sys-blue)">MP: ${p.mana !== null ? p.mana : p.displayRank}</span>
                    </div>
                </div>`).join('');

            const board = document.getElementById('game-board'); board.innerHTML = '';
            const range = (isMyTurn && me) ? getMoveRange(me.mana) : 0;
            let silverEagleOnBoard = false;

            for(let y=0; y<15; y++) {
                for(let x=0; x<15; x++) {
                    const cell = document.createElement('div'); cell.className = 'cell';
                    const key = `${x}-${y}`;
                    
                    if (state.world[key]) {
                        if(state.world[key].rank === 'Eagle') {
                            silverEagleOnBoard = true;
                            if (state.hostCosmetics?.eagle) {
                                cell.innerHTML = `<div class="custom-skin silver-eagle-glow" style="background-image: url('/uploads/skins/${state.hostCosmetics.eagle}'); width: 90%; height: 90%;"></div>`;
                            } else {
                                cell.innerHTML = `<div class="silver-eagle"></div>`;
                            }
                        } else {
                            cell.style.color = state.world[key].color; 
                            cell.innerHTML = `<div class="monolith"></div>`;
                        }
                    }
                    
                    const pAtCell = state.players.find(p => p.alive && p.x === x && p.y === y);
                    if (pAtCell) {
                         const stunStyle = pAtCell.isStunned ? 'opacity:0.5; filter:grayscale(100%);' : '';
                         
                         if (pAtCell.skin) {
                             cell.innerHTML += `<div class="custom-skin" style="${stunStyle} background-image: url('/uploads/skins/${pAtCell.skin}'); color:${pAtCell.color};"><div class="name-tag" style="color:${pAtCell.color}">${pAtCell.isAdmin?'ðŸ‘‘':''}${pAtCell.name}</div></div>`;
                         } else {
                             cell.innerHTML += `<div class="humanoid" style="${stunStyle}"><div class="name-tag" style="color:${pAtCell.color}">${pAtCell.isAdmin?'ðŸ‘‘':''}${pAtCell.name}</div><div class="h-head" style="border-color:${pAtCell.color};"></div><div class="h-body" style="border-color:${pAtCell.color};"></div></div>`;
                         }
                    }

                    if (isMyTurn && me && me.alive && !me.isStunned) {
                         const dx = Math.abs(me.x - x); const dy = Math.abs(me.y - y);
                         let isValid = false;
                         if (dx === 0 && dy === 0) isValid = false;
                         else if (dx > 0 && dy > 0) isValid = (dx === 1 && dy === 1);
                         else isValid = ((dx + dy) <= range);
                         if (isValid) { cell.classList.add('valid-move'); cell.onclick = () => socket.emit('playerAction', { tx: x, ty: y }); }
                    }
                    board.appendChild(cell);
                }
            }

            if (silverEagleOnBoard) {
                fxManager.startSilverEaglePresence();
            } else {
                fxManager.stopSilverEaglePresence();
            }
        });

        socket.on('battleStart', (data) => {
            fxManager.triggerCombatEffect();
            const panel = document.getElementById('vs-panel');
            panel.style.display = 'flex';
            document.getElementById('vs-content').innerHTML = `
                <span style="color:${data.hunterColor}; font-weight:900;">${data.hunter}</span>
                <br><span style="font-size:0.8rem; color:#666;">VS</span><br>
                <span style="color:${data.targetColor}; font-weight:900;">${data.target}</span>
                <div style="font-size:0.8rem; color:#aaa; margin-top:5px;">${data.targetRank}</div>`;
            const bar = document.getElementById('vs-bar');
            bar.style.transition = 'none';
            bar.style.width = '0%';
            setTimeout(() => { bar.style.transition = 'width 2.8s linear'; bar.style.width = '100%'; }, 50);
        });

        socket.on('battleEnd', () => { document.getElementById('vs-panel').style.display = 'none'; });

        function usePowerUp() {
            if (currentHunterPowerUp && currentGameState && currentGameState.processing) {
                socket.emit('activateSkill', { powerUp: currentHunterPowerUp });
                document.getElementById('btn-powerup').style.display = 'none';
            }
        }
        
        socket.on('broadcastPowerUp', (data) => {
            if (fxManager) {
                fxManager.triggerPowerUpEffect(data.powerUp, data.hunter);
            }
        });

        socket.on('announcement', (msg) => {
            const feed = document.getElementById('announcement-feed');
            const el = document.createElement('div');
            el.style.color = 'var(--sys-gold)';
            el.style.marginBottom = '5px';
            el.innerText = `[SYSTEM]: ${msg}`;
            feed.prepend(el);
            
            if(msg.includes("ITEM LOCKED") || msg.includes("INCORRECT ROOM PASSWORD")) {
                alert(msg);
            }
        });

        // EDITED: Added precise sound triggers here based on win/loss condition
        socket.on('victoryEvent', (data) => {
            fxManager.stopSilverEaglePresence();
            const scr = document.getElementById('victory-screen');
            scr.style.display = 'flex';
            document.getElementById('winner-name').innerText = data.winner;
            
            const isMe = (myHunter && myHunter.username === data.winner);
            const info = document.getElementById('reward-info');
            
            const isOnline = currentGameState ? currentGameState.isOnline : false;
            const isRanked = currentGameState ? currentGameState.isRanked : false;

            if (isMe) { 
                let points = 0;
                if(isOnline) points = isRanked ? 25 : 0;
                else points = 6;
                
                if (points > 0) info.innerText = `REWARD: +${points} HUNTER POINTS`; 
                else info.innerText = `UNRANKED MATCH: NO HUP REWARD`;
                
                info.style.color = 'var(--rank-e)'; 
                
                // Plays victory sound exclusively when the player wins
                playTrack('victory.mp3'); 
            } else { 
                info.innerText = `MISSION ENDED`; 
                info.style.color = '#888'; 
                
                // Plays loss sound exclusively when the final game over screen shows and the player is not the winner
                playTrack('lose.mp3'); 
            }
        });

        socket.on('sysLog', (msg) => alert(`ADMIN: ${msg}`));

        function getShortRankLabel(m) {
            if(m >= 901) return "S-RANK";
            if(m >= 701) return "A-RANK";
            if(m >= 501) return "B-RANK";
            if(m >= 301) return "C-RANK";
            if(m >= 101) return "D-RANK";
            return "E-RANK";
        }
        
        function getMoveRange(mana) {
            if (mana >= 901) return 6; 
            if (mana >= 701) return 5; 
            if (mana >= 501) return 4; 
            if (mana >= 301) return 3; 
            if (mana >= 101) return 2; 
            return 1; 
        }

        // --- PWA INSTALLATION LOGIC ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const installBtn = document.getElementById('btn-install');
            if(installBtn) installBtn.style.display = 'block';
        });

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('Hunter installed the System App');
                    }
                    deferredPrompt = null;
                    document.getElementById('btn-install').style.display = 'none';
                });
            }
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').then(() => {
                console.log('System Diagnostics: Service Worker Online');
            });
        }
    </script>
</body>
</html>


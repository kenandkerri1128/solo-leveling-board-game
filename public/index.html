<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SOLO LEVELING BOARD GAME</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@1,900&family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <style>
        :root { --sys-blue: #00d2ff; --sys-red: #ff003c; --sys-gold: #ffcc00; --sys-silver: #c0c0c0; }
        body { background: #000; color: white; font-family: 'Exo 2', sans-serif; margin: 0; overflow: hidden; }
        h1, h2, h3 { font-family: 'Orbitron'; font-style: italic; color: var(--sys-blue); text-shadow: 0 0 10px var(--sys-blue); }
        .screen { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100vh; width: 100vw; position: absolute; }
        .active { display: flex !important; }
        .sys-btn { background: #000; border: 2px solid var(--sys-blue); color: var(--sys-blue); padding: 10px 40px; font-family: 'Orbitron'; cursor: pointer; margin: 10px; font-weight: 900; clip-path: polygon(15% 0, 100% 0, 85% 100%, 0 100%); width: 250px; text-transform: uppercase; transition: 0.2s; }
        .sys-btn:hover { background: var(--sys-blue); color: #000; }
        .sys-input { padding: 15px; background: #000; border: 1px solid var(--sys-blue); color: #fff; width: 300px; margin: 10px; font-family: 'Orbitron'; outline: none; }
        #game-board { display: grid; grid-template-columns: repeat(15, 42px); gap: 2px; background: #111; border: 4px solid var(--sys-blue); }
        .cell { width: 42px; height: 42px; background: #000; position: relative; border: 0.5px solid #1a1a1a; }
        .valid-move { box-shadow: inset 0 0 0 3px var(--sys-blue); cursor: pointer; z-index: 5; }
        .humanoid { position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); width: 24px; height: 30px; z-index: 10; pointer-events: none; }
        .h-head { width: 10px; height: 10px; border-radius: 50%; border: 1px solid white; margin: 0 auto; }
        .h-body { width: 20px; height: 15px; border: 1px solid white; border-radius: 4px 4px 0 0; }
        .name-tag { position: absolute; top: -22px; left: 50%; transform: translateX(-50%); font-size: 10px; white-space: nowrap; font-weight: 900; background: #000; border: 1px solid #444; padding: 1px 4px; display: flex; flex-direction: column; align-items: center; }
        
        .hud-left { width: 280px; background: rgba(0,0,0,0.9); border-right: 2px solid var(--sys-blue); padding: 15px; display: flex; flex-direction: column; height: 650px; overflow-y: auto; }
        .guide-box { background: rgba(0, 210, 255, 0.1); border: 1px solid var(--sys-blue); padding: 10px; border-radius: 5px; margin-bottom: 20px; }
        .rank-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #222; font-size: 14px; font-weight: 900; }
        
        .sidebar { width: 350px; border: 2px solid var(--sys-blue); background: #000; padding: 15px; height: 650px; display: flex; flex-direction: column; }
        .party-member { font-size: 18px; font-weight: 900; margin-bottom: 8px; border-bottom: 1px solid #222; }
        #vs-panel { display: none; background: rgba(20,0,0,0.95); border: 2px solid var(--sys-red); padding: 15px; margin-top: 10px; flex-direction: column; align-items: center; box-shadow: 0 0 20px var(--sys-red); z-index: 1000; }
        .v-fill { height: 6px; background: var(--sys-red); width: 0%; transition: 5s linear; margin-top: 10px; }
        #turn-counter { margin-top: 10px; padding: 10px; border: 1px solid #333; font-size: 14px; text-align: center; color: var(--sys-gold); }
        #victory-screen { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; flex-direction: column; align-items: center; justify-content: center; }

        .power-icon { font-size: 14px; margin-top: 2px; color: var(--sys-gold); }
        .skill-activate-btn { background: var(--sys-gold); color: #000; border: none; padding: 8px 20px; font-family: 'Orbitron'; font-weight: 900; cursor: pointer; margin-top: 10px; animation: pulse 0.6s infinite alternate; border-radius: 4px; box-shadow: 0 0 15px var(--sys-gold); }
        @keyframes pulse { from { transform: scale(1); filter: brightness(1); } to { transform: scale(1.1); filter: brightness(1.3); } }
    </style>
</head>
<body>

    <div id="victory-screen">
        <h1 style="font-size: 5rem; color: var(--sys-gold);">QUEST COMPLETE</h1>
        <h2 id="winner-name" style="font-size: 3rem; color: #fff;">---</h2>
        <p>RECALCULATING WORLD RANKINGS...</p>
    </div>

    <div id="screen-auth" class="screen active">
        <h1 style="font-size: 4rem; letter-spacing: 15px;">SYSTEM</h1>
        <input type="text" id="u" class="sys-input" placeholder="HUNTER ID">
        <input type="password" id="p" class="sys-input" placeholder="ACCESS CODE">
        <button class="sys-btn" onclick="auth('login')">LOGIN</button>
        <button class="sys-btn" style="border-color:#444;" onclick="auth('signup')">CREATE RECORD</button>
    </div>

    <div id="screen-menu" class="screen">
        <div style="position:absolute; right:40px; top:20px; text-align:right;">
            <h1 id="st-name" style="font-size: 2.8rem; margin:0;">---</h1>
            <div id="st-world-rank" style="font-size: 1.2rem; font-weight: 900; margin: 5px 0;">WORLD RANK: ---</div>
            <div id="st-stats" style="font-size: 1rem; color: #aaa; margin-bottom: 5px;">WINS: 0 | LOSSES: 0</div>
            <div id="st-rank" style="font-size: 1.8rem; font-weight: 900; margin:0;">---</div>
            <div id="st-mp" style="font-size: 1.5rem; margin:0; color:white;">MP: ---</div>
        </div>
        <div style="border:2px solid var(--sys-blue); width:400px; padding:20px; background:rgba(0,0,0,0.8);">
            <h3>WORLD RANKINGS</h3>
            <div id="world-rank-list"></div>
        </div>
        <button class="sys-btn" onclick="showScreen('screen-difficulty')">SINGLE PLAYER</button>
        <button class="sys-btn" onclick="openOnlineLobby()">MULTIPLAYER</button>
        <button class="sys-btn" style="border-color:#555;" onclick="location.reload()">LOGOUT</button>
    </div>

    <div id="screen-online" class="screen">
        <h2>ACTIVE GATES</h2>
        <div id="gate-list" style="width:450px; height:250px; border:1px solid #333; overflow-y:auto; padding:10px;"></div>
        <input type="text" id="gn" class="sys-input" placeholder="GATE DESIGNATION">
        <button class="sys-btn" onclick="createGate()">INITIALIZE</button>
        <button class="sys-btn" onclick="showScreen('screen-menu')">BACK</button>
    </div>

    <div id="screen-waiting" class="screen">
        <h2 id="wait-title">SYNCING...</h2>
        <div id="wait-slots" style="display:flex; gap:15px; margin:20px;"></div>
        <button id="ready-btn" class="sys-btn" style="display:none; color:gold; border-color:gold;" onclick="confirmReady()">READY</button>
        <button class="sys-btn" onclick="quitAction()">ABANDON</button>
    </div>

    <div id="screen-difficulty" class="screen">
        <h2>QUEST TYPE</h2>
        <button class="sys-btn" onclick="startAI('Easy')">EASY</button>
        <button class="sys-btn" onclick="startAI('Hard')">HARD</button>
        <button class="sys-btn" onclick="startAI('Monarch')" style="color:red; border-color:red;">MONARCH (+5 MP)</button>
        <button class="sys-btn" onclick="showScreen('screen-menu')">BACK</button>
    </div>

    <div id="screen-game" class="screen" style="flex-direction: row; justify-content: center; align-items: center;">
        <div class="hud-left">
            <h3>HOW TO PLAY</h3>
            <div class="guide-box">
                <p style="color:var(--sys-gold); font-weight:900; margin:0 0 5px 0;">SYSTEM RULES:</p>
                <p style="margin:0; font-size:11px; line-height:1.4;">
                    1. Absorb <b style="color:#00ff00;">Mana Gates</b> to grow stronger.<br>
                    2. <b style="color:red;">RED GATES (S)</b> only appear after a <b style="color:cyan;">RESPAWN</b>.<br>
                    3. If you are the last hunter, a <b style="color:var(--sys-silver);">SILVER GATE</b> spawns (500+ MP). You must defeat it to win.<br>
                    4. If the survivor loses to the Silver Gate, <b style="color:cyan;">ALL HUNTERS REAWAKEN</b>. Survivor keeps MP, others gain <b style="color:var(--sys-gold);">+500-1500 MP</b>.
                </p>
            </div>

            <h3>RANKING TABLE</h3>
            <div id="rank-guide">
                <div class="rank-row" style="color:#ff0000;"><span>HIGHER S</span> <span>1000+</span></div>
                <div class="rank-row" style="color:#ff0000; opacity:0.8;"><span>LOWER S</span> <span>901-999</span></div>
                <div class="rank-row" style="color:#ff00ff;"><span>HIGHER A</span> <span>801-900</span></div>
                <div class="rank-row" style="color:#ff00ff; opacity:0.8;"><span>LOWER A</span> <span>701-800</span></div>
                <div class="rank-row" style="color:#ff9900;"><span>HIGHER B</span> <span>601-700</span></div>
                <div class="rank-row" style="color:#ff9900; opacity:0.8;"><span>LOWER B</span> <span>501-600</span></div>
                <div class="rank-row" style="color:#ffff00;"><span>HIGHER C</span> <span>401-500</span></div>
                <div class="rank-row" style="color:#ffff00; opacity:0.8;"><span>LOWER C</span> <span>301-400</span></div>
                <div class="rank-row" style="color:#99ff00;"><span>HIGHER D</span> <span>201-300</span></div>
                <div class="rank-row" style="color:#99ff00; opacity:0.8;"><span>LOWER D</span> <span>101-200</span></div>
                <div class="rank-row" style="color:#00ff00;"><span>HIGHER E</span> <span>51-100</span></div>
                <div class="rank-row" style="color:#00ff00; opacity:0.8;"><span>LOWER E</span> <span>0-50</span></div>
            </div>
        </div>

        <div style="display:flex; gap:20px;">
            <div id="game-board"></div>
            <div class="sidebar">
                <h3 id="turn-txt" style="color:var(--sys-gold); font-size: 14px;">>> SYSTEM TURN</h3>
                <div id="party-list"></div>
                <div id="vs-panel">
                    <span id="vs-title" style="color:var(--sys-red); font-weight:900;">COMBAT INITIATED</span>
                    <div id="vs-data" style="font-size: 18px; text-align: center; margin: 10px 0;"></div>
                    <div id="skill-area" style="min-height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-top: 1px solid #333; width: 100%;"></div>
                    <div style="width:100%; height:4px; background:#111;"><div class="v-fill" id="vs-fill"></div></div>
                </div>
                <div id="turn-counter">
                    <div id="tc-spawn-text">RANDOM GATE: <span id="tc-spawn">3</span> ROUNDS</div>
                    <div id="tc-silver-container" style="display:none; color:var(--sys-silver); font-weight: bold; border: 2px solid var(--sys-silver); padding: 5px; margin-top: 5px; background: rgba(255,255,255,0.1);">
                        SILVER GATE DETECTED<br>
                        POWER: <span id="silver-power">???</span>
                    </div>
                </div>
                <div id="announcement-board" style="flex-grow:1; background:#050505; font-size:11px; margin-top:10px; overflow-y:auto; padding:10px; border:1px solid #222;"></div>
                <button class="sys-btn" style="width:100%; height:45px; font-size:12px; margin-top:10px;" onclick="quitAction()">QUIT QUEST</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        
        let myHunter = null;
        let myRoomID = null;
        let currentPass = ""; 
        let currentWorldRankings = [];

        const POWER_ICONS = { 'DOUBLE DAMAGE': '‚öîÔ∏è', 'GHOST WALK': 'üë£', 'NETHER SWAP': 'üåÄ' };

        function getRankColor(index) {
            const rank = index + 1;
            if (rank <= 3) return 'var(--sys-gold)';
            if (rank <= 10) return 'var(--sys-red)';
            return 'white';
        }

        function getHunterWorldRankData(username) {
            const index = currentWorldRankings.findIndex(h => h.username === username);
            if (index === -1) return { rankText: "RANK: UNKNOWN", color: "white" };
            return {
                rankText: `WORLD RANK: ${index + 1}`,
                color: getRankColor(index)
            };
        }

        function getGameRankLabel(m) {
            if(m >= 1000) return "HIGHER S";
            if(m >= 901) return "LOWER S";
            if(m >= 801) return "HIGHER A";
            if(m >= 701) return "LOWER A";
            if(m >= 601) return "HIGHER B";
            if(m >= 501) return "LOWER B";
            if(m >= 401) return "HIGHER C";
            if(m >= 301) return "LOWER C";
            if(m >= 201) return "HIGHER D";
            if(m >= 101) return "LOWER D";
            if(m >= 51) return "HIGHER E";
            return "LOWER E";
        }

        function getShortRankLabel(m) {
            if(m >= 901) return "S-RANK";
            if(m >= 701) return "A-RANK";
            if(m >= 501) return "B-RANK";
            if(m >= 301) return "C-RANK";
            if(m >= 101) return "D-RANK";
            return "E-RANK";
        }

        function isPathBlockedClient(room, x1, y1, x2, y2) {
            let dx = x2 - x1;
            let dy = y2 - y1;
            let steps = Math.max(Math.abs(dx), Math.abs(dy));
            if (steps <= 1) return false;
            for (let i = 1; i < steps; i++) {
                let checkX = x1 + Math.round((dx / steps) * i);
                let checkY = y1 + Math.round((dy / steps) * i);
                if (room.world[`${checkX}-${checkY}`]) return true;
            }
            return false;
        }

        function showScreen(id) { 
            const screens = document.querySelectorAll('.screen');
            screens.forEach(s => s.classList.remove('active')); 
            const target = document.getElementById(id);
            if(target) target.classList.add('active'); 
            if(id === 'screen-menu' && myHunter) { 
                socket.emit('requestWorldRankings');
                socket.emit('authRequest', {type:'login', u:myHunter.username, p:currentPass}); 
            }
        }
        
        function auth(type) { 
            const u = document.getElementById('u').value;
            const p = document.getElementById('p').value;
            if(!u || !p) return alert("ENTER HUNTER CREDENTIALS");
            currentPass = p;
            socket.emit('authRequest', { type, u, p }); 
        }

        socket.on('authError', (msg) => alert(msg));
        
        socket.on('authSuccess', (d) => { 
            myHunter = d;
            document.getElementById('st-name').innerText = d.username;
            document.getElementById('st-rank').innerText = d.rank; 
            document.getElementById('st-rank').style.color = d.color;
            document.getElementById('st-mp').innerText = `MP: ${d.mana}`;
            document.getElementById('st-stats').innerText = `WINS: ${d.wins || 0} | LOSSES: ${d.losses || 0}`;
            
            const rankData = getHunterWorldRankData(d.username);
            document.getElementById('st-world-rank').innerText = rankData.rankText;
            document.getElementById('st-world-rank').style.color = rankData.color;

            if(document.getElementById('screen-auth').classList.contains('active')) showScreen('screen-menu'); 
        });

        socket.on('updateWorldRankings', (l) => {
            currentWorldRankings = l;
            if (myHunter) {
                const rankData = getHunterWorldRankData(myHunter.username);
                const stWR = document.getElementById('st-world-rank');
                stWR.innerText = rankData.rankText;
                stWR.style.color = rankData.color;
            }
            document.getElementById('world-rank-list').innerHTML = l.map((h, i) => {
                const color = getRankColor(i);
                return `<div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #222; font-weight:900; color:${color};">
                    <span>#${i+1} ${h.username}</span> 
                    <span style="color:var(--sys-blue);">${h.manapoints} MP</span>
                </div>`;
            }).join('');
        });

        function openOnlineLobby() { showScreen('screen-online'); socket.emit('requestGateList'); }
        function createGate() { socket.emit('createGate', { name: document.getElementById('gn').value || "UNKNOWN GATE", host: myHunter.username }); }
        function confirmReady() { socket.emit('playerConfirm', { gateID: myRoomID }); document.getElementById('ready-btn').style.display='none'; }
        
        socket.on('updateGateList', (gates) => {
            document.getElementById('gate-list').innerHTML = gates.map(g => `<div style="padding:10px; border-bottom:1px solid #222; display:flex; justify-content:space-between;"><span>${g.name} (${g.count}/4)</span> <button class="sys-btn" style="width:80px; padding:5px; margin:0; font-size:10px;" onclick="socket.emit('joinGate', {gateID:'${g.id}', user:myHunter.username})">JOIN</button></div>`).join('') || "NO GATES DETECTED";
        });

        socket.on('waitingRoomUpdate', (room) => {
            showScreen('screen-waiting');
            myRoomID = room.id;
            document.getElementById('wait-slots').innerHTML = room.players.map(p => {
                const rankData = getHunterWorldRankData(p.name);
                return `
                <div style="padding:15px; border:2px solid ${p.confirmed?'lime':'#444'}; background:#000; font-weight:900; text-align:center;">
                    <div style="font-size: 1.2rem;">${p.name}</div>
                    <div style="font-size: 0.8rem; color:${rankData.color}; margin-top: 5px;">${rankData.rankText}</div>
                </div>`;
            }).join('');
            if(room.players.length >= 2) document.getElementById('ready-btn').style.display = 'block';
        });

        function startAI(diff) { 
            resetGameUI();
            socket.emit('startSoloAI', { user: myHunter.username, diff }); 
        }

        function resetGameUI() {
            document.getElementById('announcement-board').innerHTML = "";
            document.getElementById('game-board').innerHTML = "";
            document.getElementById('party-list').innerHTML = "";
            document.getElementById('victory-screen').style.display = 'none';
        }

        socket.on('gameStart', () => { resetGameUI(); showScreen('screen-game'); });

        socket.on('battleStart', (d) => {
            const p = document.getElementById('vs-panel');
            const skillArea = document.getElementById('skill-area');
            const title = document.getElementById('vs-title');
            
            p.style.display = 'flex';
            skillArea.innerHTML = "";
            document.getElementById('vs-fill').style.width = '0%';
            document.getElementById('vs-data').innerHTML = `${d.hunter} <span style="color:red">VS</span> ${d.target}<br><span style="color:yellow; font-weight:900;">TARGET MP: ${d.targetMana}</span>`;
            
            if(d.powerUp) {
                const btn = document.createElement('button');
                btn.className = "skill-activate-btn";
                btn.innerHTML = `${POWER_ICONS[d.powerUp] || ''} ACTIVATE ${d.powerUp}`;
                btn.onclick = () => {
                    socket.emit('activateSkill', { powerUp: d.powerUp });
                    btn.remove();
                    skillArea.innerHTML = `<span style="color:cyan; font-weight:900;">${d.powerUp} ENGAGED!</span>`;
                };
                skillArea.appendChild(btn);
            }

            setTimeout(() => document.getElementById('vs-fill').style.width = '100%', 50);
            setTimeout(() => { p.style.display = 'none'; title.innerText = "COMBAT INITIATED"; title.style.color = "var(--sys-red)"; }, 5000);
        });

        socket.on('victoryEvent', (d) => {
            const vs = document.getElementById('victory-screen');
            vs.style.display = 'flex';
            document.getElementById('winner-name').innerText = d.winner.toUpperCase();
        });

        function quitAction() { socket.emit('quitGame'); }
        socket.on('returnToProfile', () => { resetGameUI(); showScreen('screen-menu'); });

        socket.on('announcement', (txt) => { 
            const board = document.getElementById('announcement-board');
            let color = "red";
            if (txt.includes("REAWAKENED") || txt.includes("RESURRECTED")) color = "cyan";
            if (txt.includes("SILVER GATE")) color = "var(--sys-silver)";
            
            board.innerHTML += `<div style="color:${color}; margin-bottom:5px; border-left: 2px solid ${color}; padding-left: 5px;">[ALERT] ${txt}</div>`; 
            board.scrollTop = board.scrollHeight;
        });

        socket.on('gameStateUpdate', (s) => {
            const board = document.getElementById('game-board');
            board.innerHTML = "";
            const me = s.players.find(p => p.id === socket.id);
            if(!me) return;
            const isTurn = s.players[s.turn].id === socket.id;
            
            const silverGate = Object.values(s.world).find(cell => cell.type === 'Silver');
            if (silverGate) {
                document.getElementById('tc-silver-container').style.display = 'block';
                document.getElementById('silver-power').innerText = silverGate.mana;
            } else {
                document.getElementById('tc-silver-container').style.display = 'none';
            }

            document.getElementById('tc-spawn').innerText = 3 - (Math.floor(s.globalTurns / s.players.length) % 3);
            document.getElementById('turn-txt').innerText = isTurn ? ">> YOUR MOVE" : `>> ${s.players[s.turn].name.toUpperCase()} ACTING`;

            document.getElementById('party-list').innerHTML = s.players.map(p => {
                let status = p.quit ? '(QUIT)' : (p.alive ? '' : '(KIA)');
                let powerInfo = (p.id === socket.id && p.powerUp) ? `<div class="power-icon">${POWER_ICONS[p.powerUp]} ${p.powerUp}</div>` : "";
                let rLabel = getGameRankLabel(p.mana); 
                let manaInfo = p.id === socket.id ? `[MP: ${p.mana}]` : `[${rLabel}]`;
                return `<div class="party-member" style="color:${p.quit ? '#444' : p.color}">${p.name} ${manaInfo} ${status} ${powerInfo}</div>`;
            }).join('');

            for(let y=0; y<15; y++) {
                for(let x=0; x<15; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    if(s.world[`${x}-${y}`]) cell.style.backgroundColor = s.world[`${x}-${y}`].color;
                    
                    const moveRange = s.mode === 'Monarch' ? 3 : 2;
                    const dist = Math.abs(me.x - x) + Math.abs(me.y - y);

                    if(isTurn && dist <= moveRange && dist > 0) {
                        if (!isPathBlockedClient(s, me.x, me.y, x, y)) {
                            cell.classList.add('valid-move');
                            cell.onclick = () => socket.emit('playerAction', { tx: x, ty: y });
                        }
                    }

                    s.players.forEach(p => {
                        if(p.alive && p.x === x && p.y === y) {
                            const h = document.createElement('div');
                            h.className = 'humanoid';
                            let pwrTag = (p.id === socket.id && p.powerUp) ? `<span class="power-icon">${POWER_ICONS[p.powerUp]}</span>` : "";
                            let shortRank = getShortRankLabel(p.mana);
                            h.innerHTML = `<div class="name-tag" style="color:${p.color}">${p.name} (${shortRank})${pwrTag}</div>
                                           <div class="h-head" style="background:${p.color}"></div>
                                           <div class="h-body" style="background:${p.color}"></div>`;
                            cell.appendChild(h);
                        }
                    });
                    board.appendChild(cell);
                }
            }
        });
    </script>
</body>
</html>

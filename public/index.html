<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HUNTER SYSTEM - ORIGIN</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@1,900&family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <style>
        /* UPDATED COLOR PALETTE */
        :root { 
            --sys-blue: #00d2ff; 
            --sys-gold: #ffcc00; 
            --sys-silver: #ffffff; 
            
            /* RANK COLORS */
            --rank-s: #ff0000; /* Red */
            --rank-a: #ff00ff; /* Pink */
            --rank-b: #ff9900; /* Orange */
            --rank-c: #ffff00; /* Yellow */
            --rank-d: #99ff00; /* Yellow Green */
            --rank-e: #00ff00; /* Green */
        }

        body { 
            background: #000; 
            color: white; 
            font-family: 'Exo 2', sans-serif; 
            margin: 0; 
            overflow: hidden; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent;
        }

        h1, h2, h3 { font-family: 'Orbitron'; font-style: italic; color: var(--sys-blue); text-shadow: 0 0 10px var(--sys-blue); margin: 5px 0; }
        
        /* Layouts */
        .screen { 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            width: 100vw; 
            position: absolute; 
            inset: 0; 
            background: #000; 
            z-index: 10; 
            overflow-y: auto; 
        }
        .active { display: flex !important; }
        
        /* --- FIX FOR PC/DESKTOP UI --- */
        #screen-game {
            flex-direction: row; 
            justify-content: center;
            align-items: center;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        /* UI Elements */
        .sys-btn { 
            background: #000; 
            border: 2px solid var(--sys-blue); 
            color: var(--sys-blue); 
            padding: 12px 20px; 
            font-family: 'Orbitron'; 
            cursor: pointer; 
            margin: 5px; 
            font-weight: 900; 
            clip-path: polygon(10% 0, 100% 0, 90% 100%, 0 100%); 
            min-width: 150px; 
            text-transform: uppercase; 
            transition: 0.2s; 
            letter-spacing: 2px;
            font-size: 0.9rem;
        }
        .sys-btn:hover { background: var(--sys-blue); color: #000; box-shadow: 0 0 15px var(--sys-blue); }
        .sys-btn:active { transform: scale(0.95); }
        .sys-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .sys-btn.danger { border-color: var(--rank-s); color: var(--rank-s); }
        .sys-btn.danger:hover { background: var(--rank-s); color: #000; box-shadow: 0 0 15px var(--rank-s); }
        
        .sys-btn.gold { border-color: var(--sys-gold); color: var(--sys-gold); }
        .sys-btn.gold:hover { background: var(--sys-gold); color: #000; }

        .sys-input { 
            padding: 15px; 
            background: rgba(0,0,0,0.8); 
            border: 1px solid var(--sys-blue); 
            color: #fff; 
            width: 80%; 
            max-width: 300px;
            margin: 10px; 
            font-family: 'Orbitron'; 
            outline: none; 
            text-align: center; 
            font-size: 1.1rem; 
        }
        .sys-input::placeholder { color: #444; }

        /* Auth Screen */
        #screen-auth { background: radial-gradient(circle at center, #111 0%, #000 100%); }
        #auth-msg { color: var(--rank-s); font-family: 'Orbitron'; height: 20px; font-size: 0.9rem; margin-bottom: 10px; text-shadow: 0 0 5px var(--rank-s); }

        /* Profile & Menu */
        .profile-container { display: flex; width: 95vw; height: 90vh; gap: 20px; }
        .menu-section { border: 1px solid #222; background: rgba(10,10,10,0.8); padding: 20px; display: flex; flex-direction: column; }
        
        /* RESPONSIVE GAME BOARD */
        #game-wrapper {
            display: flex;
            flex: 1; /* Allows board to take available space on PC */
            align-items: center;
            justify-content: center;
            padding: 10px;
            height: 100%;
        }

        #game-board { 
            display: grid; 
            grid-template-columns: repeat(15, 1fr); 
            gap: 1px; 
            background: #111; 
            border: 2px solid var(--sys-blue); 
            box-shadow: 0 0 20px rgba(0, 210, 255, 0.2); 
            width: 80vmin; 
            height: 80vmin;
            max-width: 650px;
            max-height: 650px;
        }

        .cell { 
            width: 100%; 
            height: 100%; 
            background: #050505; 
            position: relative; 
            border: 0.5px solid #1a1a1a; 
            transition: background 0.2s; 
        }
        .valid-move { box-shadow: inset 0 0 0 1px var(--sys-blue); cursor: pointer; background: rgba(0, 210, 255, 0.1); z-index: 5; }
        .valid-move:hover { background: rgba(0, 210, 255, 0.3); }

        /* Visuals & Characters */
        .silver-monarch { box-shadow: 0 0 10px white, inset 0 0 5px white !important; animation: pulse-silver 1.5s infinite alternate; z-index: 2; }
        @keyframes pulse-silver { 0% { box-shadow: 0 0 5px white; } 100% { box-shadow: 0 0 15px white; } }

        /* Scaled Humanoid */
        .humanoid { 
            position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%); 
            width: 60%; height: 70%; pointer-events: none; z-index: 10; 
            display: flex; flex-direction: column; align-items: center;
        }
        .h-head { width: 40%; height: 30%; border-radius: 50%; border: 1px solid white; box-shadow: 0 0 2px currentColor; background: black;}
        .h-body { width: 80%; height: 50%; border: 1px solid white; border-radius: 4px 4px 0 0; margin-top: 1px; box-shadow: 0 0 2px currentColor; background: black; }
        .name-tag { 
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%); 
            font-size: 0.6em; white-space: nowrap; font-weight: 900; 
            background: rgba(0,0,0,0.9); border: 1px solid #444; padding: 1px 3px; 
            z-index: 20; text-shadow: none; pointer-events: none;
        }

        /* Chat System */
        .chat-container { display: flex; flex-direction: column; background: rgba(0,0,0,0.6); border: 1px solid #333; flex-grow: 1; min-height: 0; }
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 5px; font-size: 0.8rem; font-family: 'Exo 2'; scrollbar-width: thin; }
        .chat-messages div { margin-bottom: 2px; line-height: 1.2; word-wrap: break-word;}
        .chat-input-area { display: flex; border-top: 1px solid #333; height: 40px; }
        .chat-input-area input { flex-grow: 1; background: transparent; border: none; color: white; padding: 5px; outline: none; font-family: 'Exo 2'; font-size: 16px; }
        .chat-input-area button { background: #222; color: var(--sys-blue); border: none; padding: 0 15px; cursor: pointer; font-weight: 900; }

        /* Admin */
        .admin-glow { color: var(--sys-gold) !important; text-shadow: 0 0 10px var(--sys-gold); }
        .admin-msg { border-left: 2px solid var(--sys-gold); padding-left: 5px; background: rgba(255, 204, 0, 0.05); }

        /* VS Screen */
        #vs-panel { display: none; background: rgba(10,0,0,0.95); border: 2px solid var(--rank-s); padding: 10px; margin-bottom: 10px; flex-direction: column; align-items: center; box-shadow: 0 0 20px var(--rank-s); }
        .v-fill { height: 8px; background: var(--rank-s); width: 0%; margin-top: 10px; box-shadow: 0 0 10px var(--rank-s); }

        /* Rank Guide */
        .rank-table { width: 100%; font-size: 0.7rem; border-collapse: collapse; color: #888; margin-top: auto; }
        .rank-table td { border-bottom: 1px solid #222; padding: 2px; }

        /* Overlays */
        #transition-overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; pointer-events: none; opacity: 0; transition: opacity 0.5s; }
        .loader-ring { width: 80px; height: 80px; border: 5px solid #111; border-top: 5px solid var(--sys-blue); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #victory-screen { background: rgba(0,0,0,0.98); z-index: 10000; text-align: center; }

        /* Gate List */
        .room-item { padding: 15px; border: 1px solid #333; margin-bottom: 5px; background: rgba(0,210,255,0.05); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .room-item:hover { background: rgba(0,210,255,0.2); border-color: var(--sys-blue); }

        /* HUD LAYOUTS (Desktop Default) */
        .hud-left { 
            width: 300px; 
            display: flex; 
            flex-direction: column; 
            height: 100%; 
            border-right: 1px solid #333; 
            padding: 20px; 
            box-sizing: border-box; 
            flex-shrink: 0; /* Ensures HUDs don't squish on PC */
        }
        .hud-right { 
            width: 300px; 
            display: flex; 
            flex-direction: column; 
            height: 100%; 
            border-left: 1px solid #333; 
            padding: 20px; 
            box-sizing: border-box; 
            flex-shrink: 0; /* Ensures HUDs don't squish on PC */
        }

        /* --- MOBILE / TABLET RESPONSIVENESS --- */
        @media (max-width: 1024px) {
            h1 { font-size: 2.5rem !important; }
            h2 { font-size: 2rem !important; }
            
            .profile-container { flex-direction: column; height: auto; overflow-y: auto; padding-bottom: 50px; width: 95vw; }
            .menu-section { width: 100%; box-sizing: border-box; }
            
            #screen-lobby > div { flex-direction: column; height: 85vh; width: 95vw; }
            
            /* Mobile Game Screen: Stack Vertically */
            #screen-game { 
                flex-direction: column; 
                justify-content: flex-start; 
                padding: 10px 0;
                overflow-y: scroll; 
                height: 100vh;
                gap: 10px;
            }

            #game-wrapper { 
                order: 1; 
                width: 100%;
                flex: none; 
                height: auto;
                display: flex;
                justify-content: center;
            } 
            
            #game-board {
                width: 90vmin; /* Scales to screen width on mobile */
                height: 90vmin;
                max-width: 650px;
                max-height: 650px;
                gap: 1px;
                border-width: 2px;
            }

            /* Adjust characters for smaller cells */
            .humanoid { width: 70%; height: 80%; bottom: 10%; }
            .h-head { width: 50%; height: 40%; }
            .h-body { width: 80%; height: 50%; }
            .name-tag { font-size: 8px; top: -12px; }

            .hud-right { 
                order: 2; 
                width: 95%; 
                border-left: none; 
                border-top: 1px solid #333; 
                padding: 10px 0; 
                height: auto; 
                min-height: auto;
                flex-shrink: 1;
            }
            
            .hud-left { 
                order: 3; 
                width: 95%; 
                border-right: none; 
                border-top: 1px solid #333; 
                padding: 10px 0; 
                height: 250px; 
                flex-shrink: 1;
            }

            .rank-table { display: none; } /* Hide rank guide on mobile to save space */
            
            .sys-btn { width: 100%; margin: 5px 0; }
        }
    </style>
</head>
<body>

    <audio id="bgm" loop></audio>

    <div id="transition-overlay">
        <div class="loader-ring"></div>
        <h2 style="letter-spacing: 5px;">TRANSFERRING...</h2>
    </div>

    <div id="victory-screen" class="screen">
        <h1 style="font-size: 3rem; color: var(--sys-gold); text-shadow: 0 0 30px var(--sys-gold);">QUEST COMPLETE</h1>
        <h2 id="winner-name" style="font-size: 2rem;">---</h2>
        <div id="reward-info" style="font-size: 1.2rem; margin: 20px 0; font-family: 'Orbitron';"></div>
        <div style="color: var(--sys-blue);">RETURNING...</div>
    </div>

    <div id="screen-auth" class="screen active">
        <h1 style="font-size: 3rem; letter-spacing: 5px; margin-bottom: 20px; text-align: center;">HUNTER SYSTEM</h1>
        <div id="auth-msg"></div>
        <input type="text" id="u" class="sys-input" placeholder="HUNTER NAME">
        <input type="password" id="p" class="sys-input" placeholder="ACCESS KEY">
        <div style="display:flex; gap:10px; margin-top:20px; flex-wrap: wrap; justify-content: center;">
            <button class="sys-btn" onclick="auth('login')">LOGIN</button>
            <button class="sys-btn" style="border-color:#444; color:#aaa;" onclick="auth('signup')">REGISTER</button>
        </div>
    </div>

    <div id="screen-menu" class="screen">
        <div class="profile-container">
            <div class="menu-section" style="flex: 2;">
                <h3>WORLD RANKING</h3>
                <div id="world-rank-list" style="width: 100%; overflow-y: auto; flex-grow: 1; border-top: 2px solid var(--sys-blue); margin-top: 10px; max-height: 400px;"></div>
                
                <div style="width: 100%; height: 250px; display: flex; flex-direction: column; margin-top: 20px;">
                    <div style="background: var(--sys-blue); color:black; padding: 5px; font-weight: 900; font-size: 0.8rem;">GLOBAL FREQUENCY</div>
                    <div id="chat-global-anchor" style="flex-grow: 1; position: relative;"></div>
                </div>
            </div>

            <div class="menu-section" style="flex: 1; text-align: right;">
                <h1 id="p-name" style="font-size: 2rem;">---</h1>
                <div id="p-wr" style="color: var(--sys-gold); font-weight: 900; font-size: 1rem;">WORLD RANK #--</div>
                <div id="p-rank" style="font-size: 1.2rem; margin: 5px 0;">---</div>
                <div id="p-stats" style="color: #888; font-size: 0.9rem;">W: 0 | L: 0</div>
                <div id="p-mp" style="color: var(--sys-blue); font-size: 1rem; margin-bottom: 20px;">HuP: ---</div>

                <div id="admin-controls" style="display:none; flex-direction:column; gap:5px; margin-bottom: 20px; width: 100%;">
                    <input id="adm-kick" class="sys-input" style="width:100%; padding: 5px; font-size: 0.8rem;" placeholder="Kick Username">
                    <button class="sys-btn danger" style="width:100%; padding: 5px;" onclick="doAdmin('kick')">KICK</button>
                    <input id="adm-bc" class="sys-input" style="width:100%; padding: 5px; font-size: 0.8rem;" placeholder="Broadcast">
                    <button class="sys-btn gold" style="width:100%; padding: 5px;" onclick="doAdmin('broadcast')">BROADCAST</button>
                </div>

                <div style="margin-top: auto; display: flex; flex-direction: column; gap: 10px; width: 100%;">
                    <button class="sys-btn gold" style="width: 100%;" onclick="startAI('Monarch')">MONARCH MODE (+5)</button>
                    <button class="sys-btn" style="width: 100%; border-color:var(--sys-blue); color:var(--sys-blue);" onclick="window.open('/guide.html', '_blank')">SYSTEM GUIDE</button>
                    <button class="sys-btn" style="width: 100%;" onclick="openOnlineLobby()">MULTIPLAYER</button>
                    <button class="sys-btn danger" style="width: 100%; border-color:#444; color:#666;" onclick="doLogout()">LOGOUT</button>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-lobby" class="screen">
        <h2 style="margin-bottom: 20px; text-align: center;">CONNECTION DECK</h2>
        <div style="display:flex; width: 95vw; height: 85vh; gap: 10px; flex-direction: column;">
            <div style="flex: 2; border: 1px solid var(--sys-blue); padding: 10px; display: flex; flex-direction: column;">
                <div style="display:flex; gap: 10px; margin-bottom: 10px;">
                    <input id="room-name" class="sys-input" style="margin:0; flex-grow:1;" placeholder="NEW ROOM NAME">
                    <button class="sys-btn" style="width: auto; margin:0;" onclick="createGate()">CREATE</button>
                </div>
                <div id="room-list" style="flex-grow: 1; overflow-y: auto;"></div>
            </div>
            <div style="flex: 1; display: flex; flex-direction: column; height: 300px;">
                <div style="background: #222; padding: 5px; text-align: center; font-weight: 900;">LOBBY CHAT</div>
                <div id="chat-lobby-anchor" style="flex-grow: 1; position: relative;"></div>
                <button class="sys-btn" style="width: 100%; margin: 10px 0 0 0;" onclick="showScreen('screen-menu')">BACK TO PROFILE</button>
            </div>
        </div>
    </div>

    <div id="screen-waiting" class="screen">
        <h2 id="wr-title" style="font-size: 2rem; margin-bottom: 20px; text-align: center;">GATE: ---</h2>
        <div style="display:flex; gap: 20px; height: 60vh; width: 95vw; flex-direction: column;">
            <div id="wr-players" style="flex: 1; border: 1px solid var(--sys-blue); padding: 10px;"></div>
            <div style="flex: 1; display: flex; flex-direction: column;">
                 <div style="background: #222; padding: 5px; text-align: center;">TEAM COMMS</div>
                 <div id="chat-waiting-anchor" style="flex-grow: 1; position: relative;"></div>
            </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px; width: 95vw; justify-content: center;">
            <button id="btn-ready" class="sys-btn gold" onclick="playerConfirm()">READY</button>
            <button class="sys-btn danger" onclick="leaveWaitingRoom()">LEAVE ROOM</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="hud-left">
            <h3 id="turn-indicator" style="color:var(--sys-gold); border-bottom: 1px solid #333; padding-bottom: 10px; font-size: 1rem;">INITIALIZING...</h3>
            <div id="ingame-party" style="margin-bottom: 10px; font-size: 0.8rem;"></div>
            
            <div style="flex-grow: 1; display: flex; flex-direction: column; min-height: 150px;">
                <div style="background: #111; padding: 5px; font-size: 0.8rem; color: #666;">SQUAD COMMS</div>
                <div id="chat-game-anchor" style="flex-grow: 1; position: relative;"></div>
            </div>
        </div>

        <div id="game-wrapper">
            <div id="game-board"></div>
        </div>

        <div class="hud-right">
            <div id="vs-panel">
                <div style="font-size: 1rem; color: var(--rank-s); font-weight: 900; letter-spacing: 2px;">COMBAT</div>
                <div id="vs-content" style="text-align: center; margin: 5px 0; font-size: 0.9rem;"></div>
                
                <button id="btn-powerup" class="sys-btn gold" style="display:none; width: 100%; margin: 5px 0; font-size: 0.8rem;" onclick="usePowerUp()">ACTIVATE RUNE</button>
                
                <div style="width: 100%; background: #222; height: 6px;"><div class="v-fill" id="vs-bar"></div></div>
            </div>

            <div style="background: #050505; border: 1px solid #222; height: 100px; padding: 5px; overflow-y: auto; margin-bottom: 10px;">
                <div id="announcement-feed" style="font-size: 0.7rem; color: #aaa;"></div>
            </div>

            <div class="rank-guide-title" style="border-bottom: 1px solid #333; margin-bottom: 5px; font-weight:900;">MP RANKING DATA</div>
            <table class="rank-table">
                <tr><td style="color:var(--rank-s)">Higher S</td><td>1000+</td></tr>
                <tr><td style="color:var(--rank-s)">Lower S</td><td>901-999</td></tr>
                <tr><td style="color:var(--rank-a)">Higher A</td><td>801-900</td></tr>
                <tr><td style="color:var(--rank-a)">Lower A</td><td>701-800</td></tr>
                <tr><td style="color:var(--rank-b)">Higher B</td><td>601-700</td></tr>
                <tr><td style="color:var(--rank-b)">Lower B</td><td>501-600</td></tr>
                <tr><td style="color:var(--rank-c)">Higher C</td><td>401-500</td></tr>
                <tr><td style="color:var(--rank-c)">Lower C</td><td>301-400</td></tr>
                <tr><td style="color:var(--rank-d)">Higher D</td><td>201-300</td></tr>
                <tr><td style="color:var(--rank-d)">Lower D</td><td>101-200</td></tr>
                <tr><td style="color:var(--rank-e)">Higher E</td><td>51-100</td></tr>
                <tr><td style="color:var(--rank-e)">Lower E</td><td>0-50</td></tr>
            </table>

            <button class="sys-btn danger" style="width: 100%; margin-top: auto;" onclick="quitAction()">QUIT QUEST</button>
        </div>
    </div>

    <div id="chat-template" style="display:none;">
        <div class="chat-container">
            <div class="chat-messages"></div>
            <div class="chat-input-area">
                <input type="text" placeholder="TRANSMIT...">
                <button>SEND</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. DEVICE FINGERPRINT SYSTEM (CRITICAL FOR ONE TAB RULE) ---
        // Generates a unique ID for this browser if one doesn't exist
        let myDeviceId = localStorage.getItem('hunter_device_id');
        if (!myDeviceId) {
            myDeviceId = 'dev_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
            localStorage.setItem('hunter_device_id', myDeviceId);
        }

        // --- 2. SEND DEVICE ID TO SERVER ---
        const socket = io({
            query: { deviceId: myDeviceId }
        });

        let myHunter = null;
        let myRoomID = 'global';
        let currentPass = "";
        let currentWorldRankings = [];
        let currentBGM = "";
        let currentGateID = null;
        let currentHunterPowerUp = null;
        let currentGameState = null; 

        const POWER_ICONS = { 
            'DOUBLE DAMAGE': '‚öîÔ∏è', 
            'AIR WALK': 'üë£', 
            'SOUL SWAP': 'üåÄ', 
            'RULERS POWER': 'üëë' 
        };

        const BGM = document.getElementById('bgm');
        function playTrack(name) {
            if(!name) return; 
            if (currentBGM !== name) {
                currentBGM = name;
                BGM.src = `/music/${name}`;
                BGM.play().catch(()=>{});
            }
        }

        window.onload = function() {
            const stored = sessionStorage.getItem('hunter_creds');
            if(stored) {
                try {
                    const c = JSON.parse(stored);
                    if(c.u && c.p) {
                        document.getElementById('u').value = c.u;
                        document.getElementById('p').value = c.p;
                        currentPass = c.p;
                        myHunter = { username: c.u }; 
                        socket.emit('authRequest', { type: 'login', u: c.u, p: c.p });
                    }
                } catch(e) {}
            }
        };

        function doLogout() {
            currentGateID = null; 
            sessionStorage.removeItem('hunter_creds');
            sessionStorage.removeItem('last_screen');
            location.reload();
        }

        function auth(type) {
            const u = document.getElementById('u').value;
            const p = document.getElementById('p').value;
            document.getElementById('auth-msg').innerText = "";
            if(!u || !p) { document.getElementById('auth-msg').innerText = "ENTER CREDENTIALS"; return; }
            currentPass = p;
            myHunter = { username: u };
            socket.emit('authRequest', { type, u, p });
        }

        socket.on('authError', (msg) => { 
            document.getElementById('auth-msg').innerText = msg;
            // Force reload if server detects multiple tabs (System Alert)
            if(msg.includes('MULTIPLE') || msg.includes('DEVICE')) { 
                alert(msg); 
                window.location.href = "about:blank"; // Close the session
            } else if(msg.includes('ALREADY')) { 
                alert(msg); 
                location.reload(); 
            }
        });

        socket.on('authSuccess', (d) => {
            myHunter = d;
            sessionStorage.setItem('hunter_creds', JSON.stringify({u: d.username, p: currentPass}));
            document.getElementById('p-name').innerText = d.username;
            document.getElementById('p-name').className = d.isAdmin ? 'admin-glow' : '';
            document.getElementById('p-rank').innerText = d.rank;
            document.getElementById('p-rank').style.color = d.color;
            document.getElementById('p-mp').innerText = `HuP: ${d.mana}`;
            document.getElementById('p-stats').innerText = `W: ${d.wins || 0} | L: ${d.losses || 0}`;
            document.getElementById('p-wr').innerText = `WORLD RANK #${d.worldRank || '--'}`;
            if (d.isAdmin) document.getElementById('admin-controls').style.display = 'flex';

            const currentScreen = document.querySelector('.screen.active').id;
            if(currentScreen !== 'screen-game') {
                const lastScreen = sessionStorage.getItem('last_screen');
                if(lastScreen && !['screen-game', 'screen-waiting', 'screen-auth'].includes(lastScreen)) {
                    showScreen(lastScreen);
                } else {
                    showScreen('screen-menu');
                }
            }
            renderRankings();
            if(d.music) playTrack(d.music);
        });

        let chatElement = null;
        function initChat() {
            const tpl = document.getElementById('chat-template');
            chatElement = tpl.firstElementChild.cloneNode(true);
            const btn = chatElement.querySelector('button');
            const inp = chatElement.querySelector('input');
            const send = () => {
                if (inp.value.trim() && myHunter) {
                    socket.emit('sendMessage', { 
                        message: inp.value, senderName: myHunter.username, 
                        roomId: myRoomID, rank: (myHunter.mana) ? getShortRankLabel(myHunter.mana) : 'Rank ?'
                    });
                    inp.value = '';
                }
            };
            btn.onclick = send;
            inp.onkeydown = (e) => { if(e.key === 'Enter') send(); };
        }
        initChat();

        function moveChatTo(anchorId, roomId) {
            myRoomID = roomId;
            socket.emit('joinChatRoom', roomId);
            const anchor = document.getElementById(anchorId);
            const box = chatElement.querySelector('.chat-messages');
            box.innerHTML = ''; 
            anchor.appendChild(chatElement);
        }

        socket.on('receiveMessage', (data) => {
            const box = chatElement.querySelector('.chat-messages');
            const line = document.createElement('div');
            if (data.isAdmin) line.classList.add('admin-msg');
            line.innerHTML = `<span style="color:#aaa; font-size:0.7em;">[${data.timestamp}]</span> 
                              <span style="color:${data.isAdmin ? 'var(--sys-gold)' : 'var(--sys-blue)'}; font-weight:900;">
                                ${data.isAdmin?'üëë':''}${data.sender}
                              </span>: <span style="color:#fff;">${data.text}</span>`;
            box.appendChild(line);
            box.scrollTop = box.scrollHeight;
        });

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id !== 'screen-auth') sessionStorage.setItem('last_screen', id);

            if (id === 'screen-menu') { playTrack('menu.mp3'); moveChatTo('chat-global-anchor', 'global'); }
            else if (id === 'screen-lobby') moveChatTo('chat-lobby-anchor', 'lobby_main');
            else if (id === 'screen-waiting') moveChatTo('chat-waiting-anchor', currentGateID);
            else if (id === 'screen-game') { playTrack('gameplay.mp3'); moveChatTo('chat-game-anchor', currentGateID); }
        }

        function transportAnimation(callback) {
            const overlay = document.getElementById('transition-overlay');
            overlay.style.display = 'flex';
            setTimeout(() => overlay.style.opacity = 1, 10);
            setTimeout(() => {
                callback();
                setTimeout(() => {
                    overlay.style.opacity = 0;
                    setTimeout(() => overlay.style.display = 'none', 500);
                }, 1000);
            }, 1500);
        }

        // --- Helper Function for Rank Letter ---
        function getRankLetter(hup) {
            if (hup >= 1000) return { letter: "S+", color: "var(--rank-s)" }; 
            if (hup >= 901) return { letter: "S", color: "var(--rank-s)" };
            if (hup >= 701) return { letter: "A", color: "var(--rank-a)" };
            if (hup >= 501) return { letter: "B", color: "var(--rank-b)" };
            if (hup >= 301) return { letter: "C", color: "var(--rank-c)" };
            if (hup >= 101) return { letter: "D", color: "var(--rank-d)" };
            return { letter: "E", color: "var(--rank-e)" };
        }

        // --- Updated renderRankings Function ---
        function renderRankings() {
            const el = document.getElementById('world-rank-list');
            el.innerHTML = currentWorldRankings.slice(0, 15).map((u, i) => {
                const rankData = getRankLetter(u.hunterpoints);
                return `
                <div style="padding: 10px; border-bottom: 1px solid #222; display:flex; justify-content:space-between; align-items: center; font-family: 'Exo 2';">
                    <div style="display:flex; align-items: center; gap: 8px;">
                        <span style="color:${i < 3 ? 'var(--sys-gold)' : '#fff'}; font-weight: 900; font-size: 0.9rem;">
                            #${i + 1} ${u.username} ${u.isAdmin ? 'üëë' : ''}
                        </span>
                        <span style="color:${rankData.color}; font-weight: 900; font-size: 1rem; border: 1px solid ${rankData.color}; padding: 0 4px; border-radius: 3px; background: rgba(0,0,0,0.5);">
                            ${rankData.letter}
                        </span>
                    </div>
                    <div style="text-align: right;">
                        <span style="color: #666; font-size: 0.8rem; margin-right: 15px;">
                            W: ${u.wins || 0} | L: ${u.losses || 0}
                        </span>
                        <span style="color:#fff; font-weight: 900; font-size: 1.1rem; width: 90px; display: inline-block;">
                            ${u.hunterpoints} HuP
                        </span>
                    </div>
                </div>
            `;
            }).join('');
        }
        socket.on('updateWorldRankings', (l) => { currentWorldRankings = l; renderRankings(); });

        function doAdmin(action) {
            if (action === 'kick') socket.emit('adminAction', { action: 'kick', target: document.getElementById('adm-kick').value });
            if (action === 'broadcast') socket.emit('adminAction', { action: 'broadcast', message: document.getElementById('adm-bc').value });
        }

        function openOnlineLobby() { if(!myHunter) return; showScreen('screen-lobby'); socket.emit('requestGateList'); }
        function createGate() { const name = document.getElementById('room-name').value; if (name) socket.emit('createGate', { host: myHunter.username, name }); }

        socket.on('updateGateList', (list) => {
            const el = document.getElementById('room-list');
            el.innerHTML = list.map(r => `<div class="room-item" onclick="socket.emit('joinGate', {gateID: '${r.id}', user: myHunter.username})"><span>${r.name} ${myHunter.isAdmin ? `<small style="color:red">[${r.id}]</small>` : ''}</span><span style="color:var(--sys-blue)">${r.count}/4</span></div>`).join('');
        });

        socket.on('waitingRoomUpdate', (room) => {
            currentGateID = room.id;
            if (!document.getElementById('screen-waiting').classList.contains('active')) showScreen('screen-waiting');
            document.getElementById('wr-title').innerText = `GATE: ${room.name}`;
            const el = document.getElementById('wr-players');
            el.innerHTML = room.players.map(p => `<div style="padding: 10px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;"><span style="color:${p.color}; font-weight:900;">${p.isAdmin?'üëë':''}${p.name}</span><span style="font-size: 0.8rem; color: #888;">${p.worldRankLabel || ''}</span><span style="color:${p.confirmed ? 'var(--rank-e)' : '#444'}">${p.confirmed ? 'READY' : 'WAITING'}</span></div>`).join('');
            const me = room.players.find(p => p.name === myHunter.username);
            const btn = document.getElementById('btn-ready');
            if (me && me.confirmed) { btn.innerText = "WAITING..."; btn.style.opacity = 0.5; btn.disabled = true; } 
            else { btn.innerText = "READY"; btn.style.opacity = 1; btn.disabled = false; }
        });

        function playerConfirm() { if(currentGateID) socket.emit('playerConfirm', { gateID: currentGateID }); }
        function leaveWaitingRoom() { currentGateID = null; socket.emit('quitGame'); showScreen('screen-lobby'); socket.emit('requestGateList'); }
        function startAI(diff) { transportAnimation(() => { socket.emit('startSoloAI', { user: myHunter.username, diff }); }); }
        socket.on('gameStart', (data) => { currentGateID = data.roomId; transportAnimation(() => { showScreen('screen-game'); }); });
        function quitAction() { socket.emit('quitGame'); currentGateID = null; document.getElementById('victory-screen').style.display = 'none'; showScreen('screen-menu'); }
        socket.on('returnToProfile', () => { currentGateID = null; document.getElementById('victory-screen').style.display = 'none'; showScreen('screen-menu'); });

        socket.on('gameStateUpdate', (state) => {
            if (!state.active) return;
            currentGameState = state;
            let me = state.players.find(p => p.id === socket.id) || state.players.find(p => p.name === myHunter.username);
            const turnPlayer = state.players[state.turn];
            const isMyTurn = (me && me.id === turnPlayer.id && !state.processing);
            const ind = document.getElementById('turn-indicator');
            
            if(turnPlayer.isStunned) { ind.innerText = `>> ${turnPlayer.name.toUpperCase()} IS STUNNED (SKIP)`; ind.style.color = '#888'; } 
            else { ind.innerText = isMyTurn ? ">> YOUR TURN" : `>> ${turnPlayer.name.toUpperCase()}'S TURN`; ind.style.color = turnPlayer.color; }

            // *** PARTICIPANT CHECK FOR POWERUP: PvP ONLY ***
            const pBtn = document.getElementById('btn-powerup');
            if (me && me.alive && me.powerUp && state.processing && state.currentBattle) {
                const isFighter = (me.id === state.currentBattle.attacker || me.id === state.currentBattle.defender);
                const isPvP = state.currentBattle.defender !== 'gate'; 
                if (isFighter && isPvP) {
                     pBtn.style.display = 'block';
                     pBtn.innerText = `ACTIVATE ${me.powerUp}`;
                     currentHunterPowerUp = me.powerUp; 
                } else { pBtn.style.display = 'none'; }
            } else { pBtn.style.display = 'none'; }

            document.getElementById('ingame-party').innerHTML = state.players.map(p => `
                <div style="padding: 5px; border-bottom: 1px solid #333; margin-bottom:5px; opacity:${p.alive?1:0.3};">
                    <div style="color:${p.color}; font-weight:900;">${p.isAdmin?'üëë':''}${p.name} ${p.isStunned?'üòµ':''} ${p.powerUp ? POWER_ICONS[p.powerUp]||'‚≠ê' : ''}</div>
                    <div style="display:flex; justify-content:space-between; font-size:0.8rem;">
                        <span>${p.worldRankLabel || ''}</span>
                        <span style="color:var(--sys-blue)">MP: ${(p.id===socket.id||(myHunter&&myHunter.isAdmin))?p.mana:p.displayRank}</span>
                    </div>
                </div>`).join('');

            const board = document.getElementById('game-board'); board.innerHTML = '';
            const range = (isMyTurn && me) ? getMoveRange(me.mana) : 0;

            for(let y=0; y<15; y++) {
                for(let x=0; x<15; x++) {
                    const cell = document.createElement('div'); cell.className = 'cell';
                    const key = `${x}-${y}`;
                    if (state.world[key]) {
                        cell.style.backgroundColor = state.world[key].color;
                        if(state.world[key].rank === 'Silver') cell.classList.add('silver-monarch');
                    }
                    const pAtCell = state.players.find(p => p.alive && p.x === x && p.y === y);
                    if (pAtCell) {
                         const stunStyle = pAtCell.isStunned ? 'opacity:0.5; filter:grayscale(100%);' : '';
                         cell.innerHTML = `<div class="humanoid" style="${stunStyle}"><div class="name-tag" style="color:${pAtCell.color}">${pAtCell.isAdmin?'üëë':''}${pAtCell.name}</div><div class="h-head" style="border-color:${pAtCell.color};"></div><div class="h-body" style="border-color:${pAtCell.color};"></div></div>`;
                    }
                    if (isMyTurn && me && me.alive && !me.isStunned) {
                         const dx = Math.abs(me.x - x); const dy = Math.abs(me.y - y);
                         let isValid = false;
                         if (dx === 0 && dy === 0) isValid = false;
                         else if (dx > 0 && dy > 0) isValid = (dx === 1 && dy === 1);
                         else isValid = ((dx + dy) <= range);
                         if (isValid) { cell.classList.add('valid-move'); cell.onclick = () => socket.emit('playerAction', { tx: x, ty: y }); }
                    }
                    board.appendChild(cell);
                }
            }
        });

        // --- BATTLE & EVENTS ---
        socket.on('battleStart', (data) => {
            const panel = document.getElementById('vs-panel');
            panel.style.display = 'flex';
            document.getElementById('vs-content').innerHTML = `
                <span style="color:${data.hunterColor}; font-weight:900;">${data.hunter}</span>
                <br><span style="font-size:0.8rem; color:#666;">VS</span><br>
                <span style="color:${data.targetColor}; font-weight:900;">${data.target}</span>
                <div style="font-size:0.8rem; color:#aaa; margin-top:5px;">${data.targetRank}</div>`;
            const bar = document.getElementById('vs-bar');
            bar.style.transition = 'none';
            bar.style.width = '0%';
            setTimeout(() => { bar.style.transition = 'width 4.8s linear'; bar.style.width = '100%'; }, 50);
        });

        socket.on('battleEnd', () => { document.getElementById('vs-panel').style.display = 'none'; });

        function usePowerUp() {
            if (currentHunterPowerUp && currentGameState && currentGameState.processing) {
                socket.emit('activateSkill', { powerUp: currentHunterPowerUp });
                document.getElementById('btn-powerup').style.display = 'none';
            }
        }

        socket.on('announcement', (msg) => {
            const feed = document.getElementById('announcement-feed');
            const el = document.createElement('div');
            el.style.color = 'var(--sys-gold)';
            el.style.marginBottom = '5px';
            el.innerText = `[SYSTEM]: ${msg}`;
            feed.prepend(el);
        });

        socket.on('victoryEvent', (data) => {
            const scr = document.getElementById('victory-screen');
            scr.style.display = 'flex';
            document.getElementById('winner-name').innerText = data.winner;
            
            const isMe = (myHunter && myHunter.username === data.winner);
            const info = document.getElementById('reward-info');
            
            // Determine rewards based on Online vs Offline (AI)
            const isOnline = currentGameState ? currentGameState.isOnline : false;

            if (isMe) { 
                info.innerText = `REWARD: +${isOnline?20:5} HUNTER POINTS`; 
                info.style.color = 'var(--rank-e)'; 
            } else { 
                info.innerText = `MISSION ENDED`; 
                info.style.color = '#888'; 
            }
        });

        socket.on('sysLog', (msg) => alert(`ADMIN: ${msg}`));

        function getShortRankLabel(m) {
            if(m >= 901) return "S-RANK";
            if(m >= 701) return "A-RANK";
            if(m >= 501) return "B-RANK";
            if(m >= 301) return "C-RANK";
            if(m >= 101) return "D-RANK";
            return "E-RANK";
        }
        
        function getMoveRange(mana) {
            if (mana >= 901) return 6; // S
            if (mana >= 701) return 5; // A
            if (mana >= 501) return 4; // B
            if (mana >= 301) return 3; // C
            if (mana >= 101) return 2; // D
            return 1; // E
        }
    </script>
</body>
</html>
